---
import '../styles/tokens.css';
import '../styles/utilities.css';
import Breakdown from '../components/Breakdown.astro';
import Modal from '../components/Modal.astro'; 
import Assumptions from '../components/Assumptions.astro';
import Inputs from '../components/Inputs.astro';
import pack from '../../data/packs/2025.1.0.json';
import compareControllerSrc from '../scripts/compare-controller.js?url';

const packSerialized = JSON.stringify(pack).replace(/</g, '\\u003c');
const packInline = `JSON.parse(decodeURIComponent('${encodeURIComponent(packSerialized)}'))`;
const seedPackScript = `(function(){try{const pack=${packInline};if(!window.__t1_pack)window.__t1_pack=pack;if(!window.__T1_PACK__)window.__T1_PACK__=pack;}catch(err){console.warn('seedPackScript failed',err);}})();`;

const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","DC","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
const STATE_LABELS = {
  AL: 'Alabama',
  AK: 'Alaska',
  AZ: 'Arizona',
  AR: 'Arkansas',
  CA: 'California',
  CO: 'Colorado',
  CT: 'Connecticut',
  DE: 'Delaware',
  DC: 'District of Columbia',
  FL: 'Florida',
  GA: 'Georgia',
  HI: 'Hawaii',
  ID: 'Idaho',
  IL: 'Illinois',
  IN: 'Indiana',
  IA: 'Iowa',
  KS: 'Kansas',
  KY: 'Kentucky',
  LA: 'Louisiana',
  ME: 'Maine',
  MD: 'Maryland',
  MA: 'Massachusetts',
  MI: 'Michigan',
  MN: 'Minnesota',
  MS: 'Mississippi',
  MO: 'Missouri',
  MT: 'Montana',
  NE: 'Nebraska',
  NV: 'Nevada',
  NH: 'New Hampshire',
  NJ: 'New Jersey',
  NM: 'New Mexico',
  NY: 'New York',
  NC: 'North Carolina',
  ND: 'North Dakota',
  OH: 'Ohio',
  OK: 'Oklahoma',
  OR: 'Oregon',
  PA: 'Pennsylvania',
  RI: 'Rhode Island',
  SC: 'South Carolina',
  SD: 'South Dakota',
  TN: 'Tennessee',
  TX: 'Texas',
  UT: 'Utah',
  VT: 'Vermont',
  VA: 'Virginia',
  WA: 'Washington',
  WV: 'West Virginia',
  WI: 'Wisconsin',
  WY: 'Wyoming'
};
const stateLabel = (code) => STATE_LABELS[code] ?? code ?? 'Select a state';
const qp = new URL(Astro.request.url).searchParams;
const leftDefault = (qp.get('a') || 'CA').toUpperCase();
const rightDefault = (qp.get('b') || 'TX').toUpperCase();
const compareConfigJSON = JSON.stringify({
  leftDefault,
  rightDefault,
  stateLabels: STATE_LABELS
}).replace(/</g, '\\u003c');
---

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>T1 - Compare States</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="Compare state tax burdens side-by-side with totals, effective rates, and category differences." />
  </head>
  <body>
    <script type="module" set:html={seedPackScript}></script>
    <main class="container stack" style="gap:1.25rem">
      <section class="panel stack" style="gap:.75rem">
        <h1 class="heading--tight">Compare states</h1>

        <div class="grid">
          <div class="stack">
            <label class="label" for="sel-left"><span>Left state</span></label>
            <select id="sel-left">
              {STATES.map(s => <option value={s} selected={s===leftDefault}>{s}</option>)}
            </select>
          </div>
          <div class="stack">
            <label class="label" for="sel-right"><span>Right state</span></label>
            <select id="sel-right">
              {STATES.map(s => <option value={s} selected={s===rightDefault}>{s}</option>)}
            </select>
          </div>
        </div>

        <!-- Header toolbar + live mini-summary + swap -->
        <div class="toolbar compare-toolbar">
          <div class="compare-toolbar__group compare-toolbar__group--primary">
            <a id="open-main" href="/" class="badge">Open main view</a>
            <span class="badge" id="toolbar-left-label">{stateLabel(leftDefault)}</span>
            <span class="chip" id="sum-left-total">--</span>
            <span class="chip" id="sum-left-eff">--</span>
            <button id="swap" type="button" class="badge" title="Swap states">Swap &lt;-&gt;</button>
            <span class="badge" id="toolbar-right-label">{stateLabel(rightDefault)}</span>
            <span class="chip" id="sum-right-total">--</span>
            <span class="chip" id="sum-right-eff">--</span>
          </div>
        </div>

      </section>

      <div class="grid grid--sidebar compare-layout">
        <section class="panel stack">
          <Inputs id="compare-inputs" />
          <details class="stack">
            <summary class="label">Assumptions & sources</summary>
            <Assumptions pack={pack} />
          </details>
        </section>

        <section class="stack" style="gap:1.25rem">
          <section class="compare-breakdowns">
            <div class="compare-breakdowns__grid">
              <div class="compare-breakdowns__item">
                <h2 id="compare-left-label" class="compare-breakdowns__title">{stateLabel(leftDefault)}</h2>
                <Breakdown initialState={leftDefault} compareSlot="left" pack={pack} />
              </div>

              <div class="compare-breakdowns__item">
                <h2 id="compare-right-label" class="compare-breakdowns__title">{stateLabel(rightDefault)}</h2>
                <Breakdown initialState={rightDefault} compareSlot="right" pack={pack} />
              </div>
            </div>
          </section>

          <!-- New: true side-by-side comparison table -->
          <section class="panel stack">
            <h2>Side-by-side comparison</h2>
            <table class="table-full" id="cmp-table" aria-live="polite">
              <thead>
                <tr>
                  <th>Category</th>
                  <th id="cmp-col-left" class="text-right">{stateLabel(leftDefault)}</th>
                  <th id="cmp-col-right" class="text-right">{stateLabel(rightDefault)}</th>
                  <th class="text-right">Diff</th>
                  <th class="text-right">Diff %</th>
                </tr>
              </thead>
              <tbody>
                <tr class="loading"><td colspan="5">Waiting for both sides...</td></tr>
              </tbody>
              <tfoot>
                <tr class="subtotal">
                  <th>Total</th>
                  <th id="cmp-left-total" class="text-right">--</th>
                  <th id="cmp-right-total" class="text-right">--</th>
                  <th id="cmp-diff-total" class="text-right">--</th>
                  <th id="cmp-diffpct-total" class="text-right">--</th>
                </tr>
              </tfoot>
            </table>
          </section>

          <section class="panel stack compare-actions">
            <h2>Share & exports</h2>
            <div class="compare-actions__buttons">
              <button type="button" class="action-pill" data-action-btn data-action="export">Export PDF</button>
              <button type="button" class="action-pill" data-action-btn data-action="chart">Open chart</button>
              <button type="button" class="action-pill" data-action-btn data-action="copy">Copy link</button>
            </div>
            <p class="compare-actions__status" id="compare-actions-status" aria-live="polite"></p>
          </section>
        </section>
      </div>
    </main>
    <Modal />
    <script id="compare-config" type="application/json" set:html={compareConfigJSON}></script>
    <script type="module" src={compareControllerSrc}></script>
  </body>
</html>

