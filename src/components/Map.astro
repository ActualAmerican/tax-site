---
import { geoAlbersUsa, geoPath } from 'd3-geo';
import { feature, mesh } from 'topojson-client';

export interface Props {
  initialStateFips?: string | null;
  initialCountyFips?: string | null;
  localScopeEnabled?: boolean;
}

const {
  initialStateFips = null,
  initialCountyFips = null,
  localScopeEnabled = false,
} = Astro.props as Props;


// Canvas size used for projection and the SVG viewBox.
const WIDTH = 960;
const HEIGHT = 520;

// Server-side: pre-render SVG paths so the map appears without client bundling.
let statePaths = [];
let nationPath = '';
if (import.meta.env.SSR) {
  try {
    const fs = await import('fs');
    const path = await import('path');
    const topoPath = path.resolve(process.cwd(), 'public', 'topo', 'states-10m.json');
    const txt = fs.readFileSync(topoPath, 'utf-8');
    const topo = JSON.parse(txt);
    const states = feature(topo, topo.objects.states);
    const nation = mesh(topo, topo.objects.nation, (a, b) => a === b);

    const projection = geoAlbersUsa().fitSize([WIDTH, HEIGHT], states);
    const pathGen = geoPath(projection);

    statePaths = (states.features || []).map((f) => ({ d: pathGen(f), id: f.id }));
    if (nation) nationPath = pathGen(nation);
  } catch (err) {
    // If topo can't be read at build-time, leave paths empty and let client render later.
    console.error('Map SSR pre-render failed:', err);
  }
}
---
<div
  class="panel"
  data-t1-map
  data-state-fips={initialStateFips ?? ''}
  data-county-fips={initialCountyFips ?? ''}
  data-local-enabled={localScopeEnabled ? '1' : '0'}
  data-local-active={localScopeEnabled ? '1' : '0'}
>
  <div class="label"><strong>US Map</strong><span id="map-selected" class="badge">--</span></div>
  <!-- Simple map controls: zoom in, zoom out, reset -->
  <div class="map-controls" role="toolbar" aria-label="Map controls">
    <button id="map-zoom-in" type="button" class="map-control-btn" aria-label="Zoom in" title="Zoom in">+</button>
    <button id="map-zoom-out" type="button" class="map-control-btn" aria-label="Zoom out" title="Zoom out">-</button>
    <button id="map-reset" type="button" class="map-control-btn" aria-label="Reset view" title="Reset view">R</button>
  </div>
  <svg
    width="100%"
    height="520"
    viewBox={`0 0 ${WIDTH} ${HEIGHT}`}
    preserveAspectRatio="xMidYMid meet"
    role="img"
    aria-label="Map of the United States"
    tabindex="0"
  >
    <!-- group we will pan/zoom by manipulating the SVG viewBox from client-side -->
    <g id="mapGroup">
      {statePaths.map(p => (
        <path d={p.d} data-fips={p.id} class="state" />
      ))}
      <g data-layer="counties" aria-hidden="true"></g>
      {nationPath ? <path d={nationPath} class="nation" /> : null}
    </g>
  </svg>
</div>
