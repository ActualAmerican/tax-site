---
/* T1 – US map (self-contained; no external script file needed) */
---
<div class="panel" data-t1-map>
  <div class="label"><strong>US Map</strong><span>Click a state</span></div>
  <svg width="100%" height="520" role="img" aria-label="Map of the United States">
    <g></g>
  </svg>
</div>

<script type="module">
  (async () => {
    // Load ESM versions of d3-geo and topojson-client so the browser can resolve bare imports.
    const d3 = await import('https://esm.sh/d3-geo@3');
    const topojson = await import('https://esm.sh/topojson-client@3');

    const { geoAlbersUsa, geoPath } = d3;
    const { feature, mesh } = topojson;

    const root = document.querySelector('[data-t1-map]');
    if (!root) return; // Not on this page — bail out.

    const svg = root.querySelector('svg');
    const g = svg.querySelector('g');

    let topoCache = null;

    async function loadTopo() {
      if (topoCache) return topoCache;
      const res = await fetch('/topo/states-10m.json');
      if (!res.ok) throw new Error('Failed to load topojson: ' + res.status);
      topoCache = await res.json();
      return topoCache;
    }

    async function render() {
      const topo = await loadTopo();
      const states = feature(topo, topo.objects.states);
      const nation = mesh(topo, topo.objects.nation, (a, b) => a === b);

      const width = root.clientWidth || 960;
      const height = 520;

      svg.setAttribute('viewBox', `0 0 ${width} ${height}`);

      const projection = geoAlbersUsa().fitSize([width, height], states);
      const path = geoPath().projection(projection);

      g.innerHTML = '';

      for (const f of states.features) {
        const p = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        p.setAttribute('d', path(f));
        if (f.id != null) p.setAttribute('data-fips', f.id);
        p.setAttribute('class', 'state');
        g.appendChild(p);
      }

      if (nation) {
        const outline = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        outline.setAttribute('d', path(nation));
        outline.setAttribute('class', 'nation');
        g.appendChild(outline);
      }
    }

    try {
      await render();
      addEventListener('resize', render);
    } catch (err) {
      // Log to console for debugging in browser
      // eslint-disable-next-line no-console
      console.error('Map render failed:', err);
    }
  })();
</script>


