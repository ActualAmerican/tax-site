<section class="locality-picker stack">
  <header class="locality-picker__header">
    <h3 class="locality-picker__title">Locality</h3>
    <button type="button" class="locality-picker__auto" data-action="autodetect">Auto-detect</button>
  </header>
  <div class="grid locality-picker__grid">
    <label class="field">
      <span class="field__label">ZIP code</span>
      <input
        id="local-zip"
        name="local-zip"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        maxlength="5"
        placeholder="e.g. 78701"
        data-field="zip"
      />
    </label>
    <label class="field">
      <span class="field__label">City</span>
      <input id="local-city" name="local-city" type="text" placeholder="Austin" data-field="city" />
    </label>
    <label class="field">
      <span class="field__label">County</span>
      <select class="field__select" data-field="county-select" disabled>
        <option value="">Select a state to load counties</option>
      </select>
    </label>
    <label class="field">
      <span class="field__label">County FIPS</span>
      <input
        id="local-county"
        name="local-county"
        type="text"
        inputmode="numeric"
        pattern="[0-9]*"
        maxlength="5"
        placeholder="48453"
        data-field="county"
      />
    </label>
  </div>
  <p class="muted-note">Local rates vary. We'll auto-update when data is connected.</p>
</section>

<script type="module">
  (function initLocalityPicker() {
  if (typeof window === 'undefined') return;

  const root = document.querySelector('.locality-picker');
  if (!root) return;

    const FALLBACK_COUNTY_DIRECTORY = {
      CA: [
        { fips: '06037', name: 'Los Angeles County' },
        { fips: '06073', name: 'San Diego County' },
        { fips: '06085', name: 'Santa Clara County' },
      ],
      FL: [
        { fips: '12086', name: 'Miami-Dade County' },
        { fips: '12099', name: 'Palm Beach County' },
        { fips: '12011', name: 'Broward County' },
      ],
      IL: [
        { fips: '17031', name: 'Cook County' },
        { fips: '17043', name: 'DuPage County' },
        { fips: '17097', name: 'Lake County' },
      ],
      NY: [
        { fips: '36061', name: 'New York County' },
        { fips: '36047', name: 'Kings County' },
        { fips: '36059', name: 'Nassau County' },
      ],
      OH: [
        { fips: '39049', name: 'Franklin County' },
        { fips: '39061', name: 'Hamilton County' },
        { fips: '39035', name: 'Cuyahoga County' },
      ],
      TX: [
        { fips: '48453', name: 'Travis County' },
        { fips: '48113', name: 'Dallas County' },
        { fips: '48201', name: 'Harris County' },
      ],
      WA: [
        { fips: '53033', name: 'King County' },
        { fips: '53061', name: 'Snohomish County' },
        { fips: '53063', name: 'Spokane County' },
      ],
    };

    const STATE_FIPS_MAP = {
      '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE','11':'DC','12':'FL','13':'GA',
      '15':'HI','16':'ID','17':'IL','18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD','25':'MA',
      '26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ','35':'NM','36':'NY',
      '37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC','46':'SD','47':'TN','48':'TX',
      '49':'UT','50':'VT','51':'VA','53':'WA','54':'WV','55':'WI','56':'WY','72':'PR'
    };
    const STATE_CODE_TO_FIPS = Object.fromEntries(Object.entries(STATE_FIPS_MAP).map(([f, code]) => [code, f]));

    let currentState = null;
    let countyDirectory = { ...FALLBACK_COUNTY_DIRECTORY };
    let loadingCounties = false;
    let lastStateCode = null;

    const countySelect = root.querySelector('[data-field="county-select"]');
    const countyInput = root.querySelector('[data-field="county"]');
    const zipInput = root.querySelector('[data-field="zip"]');
    const cityInput = root.querySelector('[data-field="city"]');

    const normalizeCountyFips = (value) => {
      if (value == null) return null;
      const digits = String(value).trim().replace(/\D+/g, '');
      if (!digits) return null;
      if (digits.length >= 5) return digits.slice(0, 5);
      return digits.padStart(5, '0');
    };

    const normalizeStateFips = (value) => {
      if (value == null) return null;
      const digits = String(value).trim().replace(/\D+/g, '');
      if (!digits) return null;
      return digits.padStart(2, '0').slice(0, 2);
    };

    const normalizeStateCode = (value) => {
      if (!value) return null;
      const trimmed = String(value).trim().toUpperCase();
      return trimmed || null;
    };

    const resolveStateCode = ({ code, stateFips, fips }) => {
      const normalizedCode = normalizeStateCode(code);
      const looksLikeFips = normalizedCode ? /^[0-9]{1,2}$/.test(normalizedCode) : false;
      if (normalizedCode && !looksLikeFips) return normalizedCode;
      const digits = looksLikeFips ? normalizedCode : stateFips || fips;
      if (!digits) return null;
      const normalized = normalizeStateFips(digits);
      return normalized ? STATE_FIPS_MAP[normalized] || null : null;
    };

    const readActiveStateCode = () => {
      const win = typeof window !== 'undefined' ? window : undefined;
      const controller = win && win.__T1_CONTROLLER__ ? win.__T1_CONTROLLER__ : null;
      const geo =
        (controller && typeof controller.getGeoSelection === 'function' && controller.getGeoSelection()) ||
        controller?.geoSelection ||
        null;
      const shared = win && win.__T1_SHARE_MODEL__ ? win.__T1_SHARE_MODEL__ : null;
      return (
        resolveStateCode({ code: geo?.code || geo?.stateCode, stateFips: geo?.stateFips }) ||
        resolveStateCode({ code: shared?.state?.code, stateFips: shared?.state?.fips }) ||
        null
      );
    };

    const loadCountyDirectory = async () => {
      const win = typeof window !== 'undefined' ? window : undefined;
      if (!win || loadingCounties) return countyDirectory;
      loadingCounties = true;
      try {
        const pack = win.__T1_PACK__ || win.__t1_pack || null;
        const href = pack?.registry?.layers?.counties?.href || null;
        if (!href) return countyDirectory;
        const res = await fetch(href);
        if (!res.ok) throw new Error(`fetch counties failed: ${res.status}`);
        const data = await res.json();
        const features = Array.isArray(data?.features) ? data.features : [];
        const nextDirectory = {};
        features.forEach((feature) => {
          const props = feature?.properties || {};
          const state = normalizeStateCode(props.state);
          const fips = normalizeCountyFips(props.fips);
          const name = props.name || null;
          if (!state || !fips || !name) return;
          if (!nextDirectory[state]) nextDirectory[state] = [];
          nextDirectory[state].push({ fips, name: String(name) });
        });
        Object.keys(nextDirectory).forEach((key) => {
          nextDirectory[key].sort((a, b) => a.name.localeCompare(b.name, 'en-US'));
        });
        if (Object.keys(nextDirectory).length) {
          countyDirectory = nextDirectory;
        }
      } catch (err) {
        try {
          console.warn('locality-picker: county directory load failed, using fallback', err);
        } catch (_e) {}
      } finally {
        loadingCounties = false;
        renderCountyOptions(currentState, normalizeCountyFips(countyInput?.value || null), { preserveCounty: true });
      }
      return countyDirectory;
    };

    const emit = () => {
      const zip = (root.querySelector('[data-field="zip"]')?.value || '').trim();
      const city = (root.querySelector('[data-field="city"]')?.value || '').trim();
      const county = (countyInput?.value || '').trim();
      let derivedState = currentState;
      if (!derivedState && county.length >= 5) {
        derivedState = STATE_FIPS_MAP[county.slice(0, 2)] || null;
      }
      if (derivedState && derivedState !== currentState) {
        currentState = derivedState;
        renderCountyOptions(currentState, county || undefined);
      }
      const countyName =
        derivedState && county
          ? (countyDirectory[derivedState] || []).find((c) => c.fips === county)?.name
          : undefined;

      const stateFips = derivedState ? STATE_CODE_TO_FIPS[derivedState] : county ? county.slice(0, 2) : undefined;

      window.dispatchEvent(
        new CustomEvent('t1:locality-changed', {
          detail: {
            zip: zip || undefined,
            city: city || undefined,
            fipsCounty: county || undefined,
            countyName: countyName || undefined,
            state: derivedState || undefined,
            stateFips: stateFips || undefined,
            source: 'picker',
          },
        }),
      );
    };

    root.querySelectorAll('[data-field]').forEach((input) => {
      if (input === countySelect) return;
      input.addEventListener('input', emit);
      input.addEventListener('change', emit);
    });

    const auto = root.querySelector('[data-action="autodetect"]');
    if (auto) {
      auto.addEventListener('click', (event) => {
        event.preventDefault();
        emit();
      });
    }

    function renderCountyOptions(code, preferredFips, opts = {}) {
      if (!countySelect) return;
      const list = (code && countyDirectory[code]) || [];
      const normalizedPreferred = normalizeCountyFips(preferredFips);
      const stateChanged = opts.stateChanged === true;
      countySelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = loadingCounties
        ? 'Loading counties...'
        : list.length
          ? 'Select a county (optional)'
          : code
            ? 'No county data yet'
            : 'Select a state to load counties';
      placeholder.selected = true;
      placeholder.disabled = loadingCounties || list.length === 0;
      countySelect.appendChild(placeholder);

      if (!list.length) {
        countySelect.setAttribute('disabled', '');
        if (countyInput) countyInput.value = '';
        if (stateChanged) emit();
        return;
      }

      list.forEach((entry) => {
        const opt = document.createElement('option');
        opt.value = entry.fips;
        opt.textContent = entry.name;
        countySelect.appendChild(opt);
      });
      countySelect.removeAttribute('disabled');
      if (normalizedPreferred && list.some((item) => item.fips === normalizedPreferred)) {
        countySelect.value = normalizedPreferred;
        if (countyInput) countyInput.value = normalizedPreferred;
      } else if (stateChanged) {
        countySelect.value = '';
        if (countyInput) countyInput.value = '';
      }
    }

    if (countySelect) {
      countySelect.addEventListener('change', () => {
        if (countyInput) {
          countyInput.value = countySelect.value || '';
        }
        emit();
      });
    }

    // Debug helper to surface state in console during wiring
    const attachDebug = () => {
      if (typeof window === 'undefined') return;
      const dbg = window.__T1_LOCALITY_DEBUG__ || {};
      dbg.getRoot = () => root;
      dbg.getState = () => currentState;
      dbg.forceState = (code) => {
        const resolved = resolveStateCode({ code });
        if (!resolved) return null;
        const stateChanged = resolved !== currentState;
        currentState = resolved;
        lastStateCode = resolved;
        renderCountyOptions(resolved, countySelect?.value || countyInput?.value || undefined, { stateChanged: true });
        return currentState;
      };
      dbg.forceRender = (code, preferredFips) => {
        const resolved = resolveStateCode({ code }) || currentState;
        renderCountyOptions(resolved, preferredFips || countySelect?.value || countyInput?.value || undefined, { stateChanged: true });
        return resolved || null;
      };
      window.__T1_LOCALITY_DEBUG__ = dbg;
      try { console.info('[t1-locality] init ok'); } catch (_e) {}
    };

    window.addEventListener('t1:state', (event) => {
      const detail = event.detail || {};
      let code = resolveStateCode({
        code: typeof detail === 'string' ? detail : detail?.code,
        fips: detail?.fips,
        stateFips: detail?.stateFips || detail?.geoSelection?.stateFips,
      });
      if (!code) {
        code = readActiveStateCode();
      }
      const stateChanged = code !== currentState;
      if (code) {
        currentState = code;
        lastStateCode = code;
        renderCountyOptions(code, countySelect?.value, { stateChanged });
      } else if (stateChanged) {
        currentState = null;
        renderCountyOptions(null, undefined, { stateChanged: true });
      }
      if (!currentState) {
        if (countyInput) countyInput.value = '';
        if (zipInput) zipInput.value = '';
        if (cityInput) cityInput.value = '';
      }
    });

    window.addEventListener('t1:geo-selection', (event) => {
      const detail = event.detail || {};
      const layer = detail?.layer || detail?.geoSelection?.layer || 'state';
      if (layer !== 'state' && layer !== 'county') return;
      const code = resolveStateCode({
        stateFips: detail.stateFips,
        fips: detail.fips,
        code: detail.code,
      });
      const countyFips = normalizeCountyFips(detail.countyFips);
      if (code) {
        const stateChanged = code !== currentState;
        currentState = code;
        lastStateCode = code;
        renderCountyOptions(code, countyFips || countySelect?.value, { stateChanged });
        if (countyInput && countyFips) countyInput.value = countyFips;
        if (stateChanged && !countyFips && countyInput) countyInput.value = '';
      }
    });

    window.addEventListener('t1:local-scope', (event) => {
      const detail = event.detail || {};
      const countyFips = normalizeCountyFips(detail.countyFips);
      const stateCode = resolveStateCode({
        stateFips: detail.stateFips,
        fips: detail.fips,
        code: detail.code,
      });
      if (stateCode && stateCode !== currentState) {
        currentState = stateCode;
        lastStateCode = stateCode;
        renderCountyOptions(stateCode, countyFips || undefined, { stateChanged: true });
      } else if (countyFips) {
        renderCountyOptions(currentState, countyFips || undefined, { preserveCounty: true });
      } else if (detail.enabled === true && !currentState) {
        const restored = readActiveStateCode() || lastStateCode || null;
        if (restored) {
          currentState = restored;
          lastStateCode = restored;
          renderCountyOptions(restored, undefined, { stateChanged: true });
        }
      }
      if (countyInput && countyFips !== undefined) countyInput.value = countyFips || '';
      if (countySelect && countyFips) countySelect.value = countyFips;
      if (zipInput && typeof detail.zip === 'string') zipInput.value = detail.zip;
      if (cityInput && typeof detail.city === 'string') cityInput.value = detail.city;
    });

    window.addEventListener('t1:locality-changed', (event) => {
      const detail = event.detail || {};
      if (detail && detail.source === 'picker') return;
      const countyFipsRaw = detail?.fipsCounty || detail?.countyFips || detail?.fips || null;
      const countyFips = normalizeCountyFips(countyFipsRaw);
      if (countyInput && countyFips !== null) countyInput.value = countyFips;
      if (zipInput && typeof detail.zip === 'string') zipInput.value = detail.zip;
      if (cityInput && typeof detail.city === 'string') cityInput.value = detail.city;
    });

    const controller = typeof window !== 'undefined' ? window.__T1_CONTROLLER__ || null : null;
    const initialScope =
      (controller && typeof controller.getLocalScope === 'function' && controller.getLocalScope()) ||
      (controller && typeof controller._getLocalScope === 'function' && controller._getLocalScope()) ||
      controller?.localScope ||
      null;
    const initialGeo =
      (controller && typeof controller.getGeoSelection === 'function' && controller.getGeoSelection()) ||
      (controller && typeof controller._getGeoSelection === 'function' && controller._getGeoSelection()) ||
      controller?.geoSelection ||
      null;
    if (initialScope?.zip && zipInput) zipInput.value = initialScope.zip;
    if (initialScope?.city && cityInput) cityInput.value = initialScope.city;
    if (initialGeo || initialScope) {
      const stateFips = normalizeStateFips(initialGeo?.stateFips || initialScope?.stateFips);
      const countyFips = normalizeCountyFips(initialGeo?.countyFips || initialScope?.countyFips);
      const stateCode = stateFips ? STATE_FIPS_MAP[stateFips] || null : null;
      if (stateCode) {
        currentState = stateCode;
        lastStateCode = stateCode;
        renderCountyOptions(stateCode, countyFips || undefined, { stateChanged: true });
        if (countyInput && countyFips) countyInput.value = countyFips;
      }
    }
    if (!currentState) {
      const derived = readActiveStateCode();
      if (derived) {
        currentState = derived;
        lastStateCode = derived;
        renderCountyOptions(derived, normalizeCountyFips(countyInput?.value || null) || undefined, { stateChanged: true });
      }
    }
    loadCountyDirectory();
    attachDebug();
  })();
</script>
