<div class="inputs-local stack">
  <div class="inputs-local__group" role="group" aria-label="Local tax categories">
    <button type="button" data-cat="local-income" aria-pressed="true" class="scope-chip scope-chip--local">
      Local income
    </button>
    <button type="button" data-cat="local-sales" aria-pressed="true" class="scope-chip scope-chip--local">
      Local sales
    </button>
    <button type="button" data-cat="lodging" aria-pressed="false" class="scope-chip scope-chip--local">
      Lodging &amp; short-term stay
    </button>
    <button type="button" data-cat="car-rental" aria-pressed="false" class="scope-chip scope-chip--local">
      Car rental
    </button>
    <button type="button" data-cat="prepared-foods" aria-pressed="false" class="scope-chip scope-chip--local">
      Prepared foods
    </button>
    <button type="button" data-cat="parking" aria-pressed="false" class="scope-chip scope-chip--local">
      Parking &amp; admissions
    </button>
  </div>
  <p class="muted-note" data-local-note>Select a state to load county-specific options. Local toggles are available while we wire the math.</p>
</div>

<script type="module">
  (function initLocalInputs() {
    const script = document.currentScript;
    if (!script) return;
    const root = script.previousElementSibling;
    if (!root || !root.matches('.inputs-local')) return;
    const note = root.querySelector('[data-local-note]');
    const controller = typeof window !== 'undefined' ? window.__T1_CONTROLLER__ : null;
    const categoryButtons = Array.from(root.querySelectorAll('button[data-cat]'));
    const CATEGORY_KEYS = categoryButtons
      .map((btn) => btn.getAttribute('data-cat'))
      .filter((key) => typeof key === 'string' && key.length > 0);

    const readCategories = () => {
      const result = {};
      categoryButtons.forEach((btn) => {
        const key = btn.getAttribute('data-cat');
        if (!key) return;
        result[key] = btn.getAttribute('aria-pressed') === 'true';
      });
      return result;
    };

    const applyCategories = (categories) => {
      if (!categories) return;
      categoryButtons.forEach((btn) => {
        const key = btn.getAttribute('data-cat');
        if (!key || !Object.prototype.hasOwnProperty.call(categories, key)) return;
        const next = !!categories[key];
        btn.setAttribute('aria-pressed', next ? 'true' : 'false');
        btn.classList.toggle('is-active', next);
      });
    };

    const encodeCategories = (categories) => {
      let mask = 0;
      CATEGORY_KEYS.forEach((key, idx) => {
        if (categories && categories[key]) {
          mask |= 1 << idx;
        }
      });
      return mask;
    };

    const emitLocalScopeFallback = (categories) => {
      const toggles = encodeCategories(categories);
      window.dispatchEvent(
        new CustomEvent('t1:local-scope', {
          detail: {
            categories,
            toggles,
            __origin: 'inputs-local-fallback',
          },
        }),
      );
    };

    const persistCategories = (categories) => {
      if (controller && typeof controller.setLocalScope === 'function') {
        controller.setLocalScope({ categories }, { origin: 'inputs-local' });
        return;
      }
      emitLocalScopeFallback(categories);
    };

    root.addEventListener('click', (event) => {
      const btn = event.target.closest('button[data-cat]');
      if (!btn) return;
      const next = btn.getAttribute('aria-pressed') !== 'true';
      btn.setAttribute('aria-pressed', next ? 'true' : 'false');
      btn.classList.toggle('is-active', next);
      const categories = readCategories();
      persistCategories(categories);
    });

    function updateNote(code) {
      if (!note) return;
      note.textContent = code
        ? `County list ready for ${code}. Toggle local categories below.`
        : 'Select a state to load county-specific options. Local toggles are available while we wire the math.';
    }

    updateNote(null);
    window.addEventListener('t1:state', (event) => {
      const detail = event.detail || {};
      updateNote(detail.code || null);
    });

    window.addEventListener('t1:local-scope', (event) => {
      const detail = event.detail || {};
      if (!detail || !detail.categories) return;
      applyCategories(detail.categories);
    });

    const initialScope =
      (controller && typeof controller.getLocalScope === 'function' && controller.getLocalScope()) ||
      (controller && controller.localScope ? controller.localScope : null);
    if (initialScope && initialScope.categories) {
      applyCategories(initialScope.categories);
    }
  })();
</script>
