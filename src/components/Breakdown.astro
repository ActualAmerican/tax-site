---
/* Breakdown panel (bundled module import) */
const { initialState = 'CA', compareSlot } = Astro.props;
const slot = compareSlot ?? 'solo';
---
<div
  class="panel stack"
  data-t1-breakdown
  data-slot={slot}
  data-state={initialState}
>
  <!-- Header with live chips + toolbar -->
  <div class="header--space">
    <div class="stack--row">
      <strong>Breakdown</strong>
      <span id="bd-state" class="badge" role="status" aria-live="polite">{initialState}</span>
      <span class="chip" id="chip-total">â€”</span>
      <span class="chip" id="chip-eff">â€”</span>
    </div>
    <div class="toolbar">
      <a class="badge" id="bd-export" href={`/report?state=${initialState}`}>Export PDF</a>
      <a class="badge" id="bd-compare" href={`/compare?a=${initialState}`}>Compareâ€¦</a>
      <button class="badge" id="bd-pie" type="button" title="Open pie chart">Open chart</button>
      <button class="badge" id="bd-copy" type="button">Copy link</button>
    </div>
  </div>

  <!-- Filled stacked bar -->
  <div id="chart" class="bar" aria-label="Stacked tax burden bar"></div>

  <table id="tbl" class="table-full">
    <thead>
      <tr>
        <th>Category</th>
        <th class="text-right">Amount</th>
        <th class="text-right">%</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th id="tot" class="text-right"></th>
        <th id="eff" class="text-right"></th>
      </tr>
    </tfoot>
  </table>
  <div id="bd-error" class="panel error no-print" hidden></div>
</div>

<!-- Client: listens for state & inputs, renders rows, stacked bar, and manages toolbar -->
<script type="module">
(function () {
  // Panel root
  const root =
    (document.currentScript && document.currentScript.previousElementSibling) ||
    document.querySelector('[data-t1-breakdown]');
  if (!root) return;

  // Loading row until first compute
  const _tbody = root.querySelector('tbody');
  function setLoadingRow() {
    if (!_tbody) return;
    _tbody.innerHTML = '<tr class="loading"><td colspan="3">Loading latest tax dataâ€¦</td></tr>';
  }
  setLoadingRow();
  // Defensively normalize the loading text if encoding was garbled
  try {
    const _cell = _tbody && _tbody.querySelector('.loading td');
    if (_cell) _cell.textContent = 'Loading latest tax dataâ€¦';
  } catch {}

  const slot       = root.getAttribute('data-slot') || 'solo';
  const stateLabel = root.querySelector('#bd-state');
  const exportLink = root.querySelector('#bd-export');
  const compareLink= root.querySelector('#bd-compare');
  const copyBtn    = root.querySelector('#bd-copy');
  const pieBtn     = root.querySelector('#bd-pie');
  const chipTotal  = root.querySelector('#chip-total');
  const chipEff    = root.querySelector('#chip-eff');
  const barEl      = root.querySelector('#chart');

  // Lightweight analytics hooks (safe no-ops if module missing)
  try {
    if (copyBtn) copyBtn.addEventListener('click', async () => {
      try { (await import('../lib/analytics.ts')).track('copy_link', { page: slot, state: root.getAttribute('data-state') }); } catch {}
    });
    if (pieBtn) pieBtn.addEventListener('click', async () => {
      try { (await import('../lib/analytics.ts')).track('open_chart', { page: slot, state: root.getAttribute('data-state') }); } catch {}
    });
    if (exportLink) exportLink.addEventListener('click', async () => {
      try { (await import('../lib/analytics.ts')).track('export_pdf', { page: slot, state: root.getAttribute('data-state') }); } catch {}
    });
  } catch {}

  // Normalize any garbled glyphs in static markup
  if (compareLink) compareLink.textContent = 'Compareâ€¦';
  if (chipTotal && (!chipTotal.textContent || /[^\w$%]/.test(chipTotal.textContent))) chipTotal.textContent = 'â€”';
  if (chipEff   && (!chipEff.textContent   || /[^\w$%]/.test(chipEff.textContent)))   chipEff.textContent   = 'â€”';

  // FIPS â†’ USPS map
  const FIPS_TO_CODE = {
    '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE','11':'DC','12':'FL','13':'GA',
    '15':'HI','16':'ID','17':'IL','18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD','25':'MA',
    '26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ','35':'NM','36':'NY',
    '37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC','46':'SD','47':'TN','48':'TX',
    '49':'UT','50':'VT','51':'VA','53':'WA','54':'WV','55':'WI','56':'WY','72':'PR'
  };
  function normalizeStateCode(input) {
    if (!input) return null;
    const s = String(input).toUpperCase();
    if (/^[A-Z]{2}$/.test(s)) return s;
    const two = s.padStart(2,'0');
    return FIPS_TO_CODE[two] || null;
  }

  // Color mapping for categories (matches tokens.css)
  const COLOR = {
    income:      'var(--t1-income)',
    sales:       'var(--t1-sales)',
    property:    'var(--t1-property)',
    excise:      'var(--t1-excise)',
    fuel:        'var(--t1-fuel)',
    fed_income:  'var(--t1-fed-income)',
    payroll:     'var(--t1-payroll)',
    ltcg:        'var(--t1-ltcg)'
  };
  function colorForKey(k){ return COLOR[k] || 'var(--accent)'; }

  // Latest inputs seen by this panel
  let latestInputs = {
    filingStatus: 'single',
    income: 60000,
    homeowner: true,
    homeValue: 300000,
    miles: 12000,
    mpg: 28,
    spendingShare: 0.60,
    taxableShare: 0.55,
    includeFederal: false,
    ltcg: 0
  };

  // Ignore stale async renders
  let _seq = 0;

  // Pack fetch/cache
  let _packCache = null;
  async function loadPack() {
    if (_packCache) return _packCache;
    try {
      const res = await fetch('/data/packs/2025.1.0.json');
      if (!res.ok) throw new Error('pack fetch failed');
      _packCache = await res.json();
      return _packCache;
    } catch (err) {
      console.warn('Breakdown: failed to load pack', err);
      _packCache = null;
      try {
        const b = root.querySelector('#bd-error');
        if (b) {
          b.removeAttribute('hidden');
          b.textContent = 'Failed to load tax data. Retry?';
          const btn = document.createElement('button'); btn.textContent = 'Retry'; btn.className='badge'; btn.onclick = () => { b.setAttribute('hidden',''); setLoadingRow(); _packCache=null; computeDemoBreakdown(root.getAttribute('data-state')||'CA'); };
          b.appendChild(document.createTextNode(' ')); b.appendChild(btn);
        }
      } catch {}
      return null;
    }
  }

  function findRow(arr, state) {
    if (!arr) return null;
    return (arr.find(r => String(r.state).toUpperCase() === String(state).toUpperCase()) || null);
  }

  function isStub(r, kind) {
    if (!r) return true;
    if (r.__stub === true || r.stub === true) return true;
    if (kind === 'income') {
      if (r.has_income_tax === false) return false;
      const hasBrackets = Array.isArray(r.brackets) && r.brackets.length > 0;
      const hasFlat = typeof r.flat === 'number';
      return !(hasBrackets || hasFlat);
    }
    if (kind === 'sales')    return !(typeof r.combined_rate  === 'number');
    if (kind === 'property') return !(typeof r.effective_rate === 'number');
    return false;
  }

  function computeFederalTotals(pack, inputs) {
    const fed = pack && pack.federal ? pack.federal : null;
    const fs  = (inputs.filingStatus || 'single').toLowerCase();
    const inc = Number(inputs.income) || 0;
    const ltcg = Number(inputs.ltcg) || 0;

    function taxFromBrackets(def, taxable, stdDedOverride) {
      if (!def) return 0;
      const std = stdDedOverride != null ? stdDedOverride : (def.standard_deduction || 0);
      const base = Math.max(0, taxable - std);
      let tax = 0, prev = 0;
      const brackets = def.brackets || [];
      for (const b of brackets) {
        const cap = (b.up_to == null) ? base : b.up_to;
        const slice = Math.max(0, Math.min(base, cap) - prev);
        tax += slice * (b.rate || 0);
        prev = cap;
        if (prev >= base) break;
      }
      return Math.round(tax);
    }

    const incomeDef = fed && fed.income && (fed.income[fs] || fed.income.single) || null;
    const federalIncome = taxFromBrackets(incomeDef, inc);

    const pr = fed && fed.payroll || {};
    const ssBase   = pr.ss_wage_base ?? 168600;
    const ssRate   = pr.ss_rate ?? 0.062;
    const mediRate = pr.medicare_rate ?? 0.0145;
    const addRate  = pr.addl_medicare_rate ?? 0.009;
    const addThreshMap = pr.addl_threshold || { single: 200000, married: 250000 };
    const addThresh = addThreshMap[fs] ?? 200000;

    const ss   = Math.min(inc, ssBase) * ssRate;
    const medi = inc * mediRate + Math.max(0, inc - addThresh) * addRate;
    const payroll = Math.round(ss + medi);

    let ltcgTax = 0;
    const cgDef = fed && fed.ltcg && (fed.ltcg[fs] || fed.ltcg.single) || null;
    if (cgDef && ltcg > 0) {
      let prev = 0;
      const brackets = cgDef.brackets || [];
      for (const b of brackets) {
        const cap = (b.up_to == null) ? ltcg : b.up_to;
        const slice = Math.max(0, Math.min(ltcg, cap) - prev);
        ltcgTax += slice * (b.rate || 0);
        prev = cap;
        if (prev >= ltcg) break;
      }
      ltcgTax = Math.round(ltcgTax);
    }

    return {
      federalIncome,
      payroll,
      ltcgTax,
      total: federalIncome + payroll + ltcgTax,
      payrollAssumptions: { ssBase, ssRate, mediRate, addRate, addThresh }
    };
  }

  // Utilities
  const fmt = (v) => '$' + (Number(v || 0)).toLocaleString();
  function pctOf(part, total){ return ((part / Math.max(1,total)) * 100).toFixed(0) + '%'; }

  function renderBreakdownRows(stateRows, federalRows, totals) {
    const tbody = root.querySelector('tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const addGroupHeader = (label) => {
      const tr = document.createElement('tr');
      tr.className = 'group';
      const th = document.createElement('th');
      th.colSpan = 3;
      th.textContent = label;
      tr.appendChild(th);
      tbody.appendChild(tr);
    };

    const addRow = (r) => {
      const tr = document.createElement('tr');
      const tdCat = document.createElement('td');
      if (r.title) tdCat.innerHTML = `<span title="${r.title.replace(/"/g, '&quot;')}">${r.label}</span>`;
      else         tdCat.textContent = r.label;
      const tdAmt = document.createElement('td'); tdAmt.className = 'text-right'; tdAmt.textContent = r.amount;
      const tdPct = document.createElement('td'); tdPct.className = 'text-right'; tdPct.textContent = r.pct;
      tr.appendChild(tdCat); tr.appendChild(tdAmt); tr.appendChild(tdPct);
      tbody.appendChild(tr);
    };

    const addSubtotal = (label, amount, pct) => {
      const tr = document.createElement('tr');
      tr.className = 'subtotal';
      const th = document.createElement('th'); th.textContent = label;
      const tdAmt = document.createElement('td'); tdAmt.className = 'text-right'; tdAmt.textContent = amount;
      const tdPct = document.createElement('td'); tdPct.className = 'text-right'; tdPct.textContent = pct;
      tr.appendChild(th); tr.appendChild(tdAmt); tr.appendChild(tdPct);
      tbody.appendChild(tr);
    };

    if (stateRows.length) {
      addGroupHeader('State taxes');
      stateRows.forEach(addRow);
      addSubtotal('State subtotal', totals.state.amount, totals.state.pct);
    }
    if (federalRows.length) {
      addGroupHeader('Federal taxes');
      federalRows.forEach(addRow);
      addSubtotal('Federal subtotal', totals.federal.amount, totals.federal.pct);
    }
  }

  function buildCompareHref(code){
    const u = new URL(location.href);
    u.pathname = '/compare';
    u.searchParams.set('a', code);
    if (!u.searchParams.get('b')) u.searchParams.set('b','TX');
    return u.toString();
  }

  // state for the chart button
  let _lastSegments = [];

  // Render stacked bar
  function renderStackedBar(segments, total){
    if (!barEl) return;
    barEl.innerHTML = '';
    const positive = segments.filter(s => s.value > 0);
    for (const s of positive) {
      const seg = document.createElement('section');
      seg.className = 'bar-seg';
      seg.style.width      = ((s.value / Math.max(1,total)) * 100) + '%';
      seg.style.background = s.color;
      seg.title = `${s.label}: ${fmt(s.value)} (${pctOf(s.value,total)})`;
      seg.setAttribute('aria-label', `${s.label}: ${fmt(s.value)} (${pctOf(s.value,total)})`);
      barEl.appendChild(seg);
    }
  }

  // Build inline SVG donut for the modal
  function buildPieHTML(title, segments){
    const data = segments.filter(s=>s.value>0);
    const total = data.reduce((a,s)=>a+s.value,0) || 1;
    const size=320, cx=size/2, cy=size/2, r=120, r0=72;

    let a0 = -Math.PI/2; // start at top
    const arcs = [];
    for (const s of data){
      const a1 = a0 + (s.value/total) * Math.PI*2;
      const large = (a1 - a0) > Math.PI ? 1 : 0;
      const x0 = cx + r*Math.cos(a0), y0 = cy + r*Math.sin(a0);
      const x1 = cx + r*Math.cos(a1), y1 = cy + r*Math.sin(a1);
      const x0i = cx + r0*Math.cos(a0), y0i = cy + r0*Math.sin(a0);
      const x1i = cx + r0*Math.cos(a1), y1i = cy + r0*Math.sin(a1);
      const d = [
        `M ${x0} ${y0}`,
        `A ${r} ${r} 0 ${large} 1 ${x1} ${y1}`,
        `L ${x1i} ${y1i}`,
        `A ${r0} ${r0} 0 ${large} 0 ${x0i} ${y0i}`,
        'Z'
      ].join(' ');
      arcs.push(`<path d="${d}" fill="${s.color}" />`);
      a0 = a1;
    }

    const legend = data.map(s => `
      <div class="legend__item">
        <span class="legend__swatch" style="background:${s.color}"></span>
        <span>${s.label} â€” <strong>${fmt(s.value)}</strong> (${pctOf(s.value,total)})</span>
      </div>
    `).join('');

    return `
      <div class="stack">
        <div class="big-number">${title}</div>
        <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" aria-label="Tax composition">
          ${arcs.join('')}
        </svg>
        <div class="legend">${legend}</div>
      </div>
    `;
  }

  async function computeDemoBreakdown(code) {
    const mySeq = ++_seq;

    const inc  = Number(latestInputs.income) || 0;
    const hv   = Number(latestInputs.homeValue) || 0;

    const pack = await loadPack();
    if (!pack) { setLoadingRow(); return; }
    if (mySeq !== _seq) return; // stale compute, abort

    // ----- STATE CATEGORIES -----
    let stIncome = 0, stIncomeMissing = false;
    if (pack && pack.income) {
      const row = findRow(pack.income, code);
      if (!row || isStub(row, 'income')) {
        stIncomeMissing = true;
      } else if (row.has_income_tax) {
        const std = row.standard_deduction || 0;
        const taxable = Math.max(0, inc - std);
        if (typeof row.flat === 'number') {
          stIncome = Math.round(taxable * row.flat);
        } else {
          const brackets = row.brackets || [];
          let prev = 0;
          for (const b of brackets) {
            const cap = (b.up_to == null) ? taxable : b.up_to;
            const slice = Math.max(0, Math.min(taxable, cap) - prev);
            stIncome += Math.round(slice * (b.rate || 0));
            prev = cap;
            if (prev >= taxable) break;
          }
        }
      } else {
        stIncomeMissing = true;
      }
    } else {
      stIncomeMissing = true;
    }

    let stSales = 0, stSalesMissing = false;
    if (pack && pack.sales) {
      const srow = findRow(pack.sales, code);
      if (!srow || isStub(srow, 'sales')) {
        stSalesMissing = true;
      } else {
        const rate = srow.combined_rate || 0;
        const spendingShare = Number(latestInputs.spendingShare) || 0.6;
        stSales = Math.round(inc * spendingShare * rate);
      }
    } else {
      stSalesMissing = true;
    }

    let stProperty = 0, stPropertyMissing = false;
    if (pack && pack.property) {
      const prow = findRow(pack.property, code);
      if (!prow || isStub(prow, 'property')) {
        stPropertyMissing = true;
      } else {
        const effRate = prow.effective_rate || 0;
        stProperty = Math.round(hv * effRate);
      }
    } else {
      stPropertyMissing = true;
    }

    // ----- FEDERAL (optional) -----
    let fedIncome = 0, fedPayroll = 0, fedLTCG = 0, payrollTitle = '';
    if (latestInputs.includeFederal) {
      const f = computeFederalTotals(pack, latestInputs);
      fedIncome  = f.federalIncome;
      fedPayroll = f.payroll;
      fedLTCG    = f.ltcgTax;

      const p = f.payrollAssumptions || {};
      if (p && p.ssBase != null) {
        payrollTitle = [
          `Social Security wage base $${Number(p.ssBase).toLocaleString()}`,
          `OASDI ${(p.ssRate*100).toFixed(1)}%`,
          `Medicare ${(p.mediRate*100).toFixed(2)}%`,
          `+ ${(p.addRate*100).toFixed(1)}% above $${Number(p.addThresh).toLocaleString()}`
        ].join(' Â· ');
      }
    }

    // Build rows + totals
    const stateNumeric = [
      { key:'income',   label: 'Income tax',   value: stIncomeMissing   ? null : stIncome },
      { key:'sales',    label: 'Sales tax',    value: stSalesMissing    ? null : stSales },
      { key:'property', label: 'Property tax', value: stPropertyMissing ? null : stProperty },
    ];
    const federalNumeric = [];
    if (latestInputs.includeFederal) {
      federalNumeric.push({ key:'fed_income', label: 'Federal income',     value: fedIncome });
      federalNumeric.push({ key:'payroll',    label: 'Payroll (employee)', value: fedPayroll, title: payrollTitle || undefined });
      if (fedLTCG > 0) federalNumeric.push({ key:'ltcg', label:'LTCG', value: fedLTCG });
    }

    const total = [...stateNumeric, ...federalNumeric].reduce((a, r) => a + (r.value ?? 0), 0);
    const stateSum = stateNumeric.reduce((a, r) => a + (r.value ?? 0), 0);
    const fedSum   = federalNumeric.reduce((a, r) => a + (r.value ?? 0), 0);

    const toDisplay = (arr) => arr.map(r => ({
      key:    r.key,
      label:  r.label,
      amount: r.value == null ? 'â€”' : fmt(r.value),
      pct:    r.value == null ? 'â€”' : pctOf(r.value,total),
      title:  r.title
    }));
    const stateDisplay   = toDisplay(stateNumeric);
    const federalDisplay = toDisplay(federalNumeric);

    // Normalize any placeholder/dash output to concrete zeros for MVP (no dashes)
    function normalizeDisplay(arr){
      return arr.map(r => ({
        ...r,
        amount: (typeof r.amount === 'string' && r.amount.indexOf('\uFFFD') >= 0) ? '$0' : r.amount,
        pct:    (typeof r.pct    === 'string' && r.pct.indexOf('\uFFFD')    >= 0) ? '0.0%' : r.pct,
      }));
    }
    const stateDisplayNorm   = normalizeDisplay(stateDisplay);
    const federalDisplayNorm = normalizeDisplay(federalDisplay);

    // Update chips + table
    const totEl = root.querySelector('#tot');
    const effEl = root.querySelector('#eff');
    if (totEl) totEl.textContent = fmt(total);
    const effRateStr = ((total / Math.max(1, inc)) * 100).toFixed(1) + '%';
    if (effEl) effEl.textContent = effRateStr;
    if (chipTotal) chipTotal.textContent = totEl ? totEl.textContent : fmt(total);
    if (chipEff)   chipEff.textContent   = effEl ? effEl.textContent : effRateStr;

    renderBreakdownRows(
      stateDisplayNorm,
      federalDisplayNorm,
      { state: { amount: fmt(stateSum), pct: pctOf(stateSum,total) }, federal: { amount: fmt(fedSum), pct: pctOf(fedSum,total) } }
    );

    // Build stacked-bar segments (state + federal) with colors
    const segments = [...stateNumeric, ...federalNumeric]
      .filter(r => (r.value ?? 0) > 0)
      .map(r => ({ key:r.key, label:r.label, value:r.value, color: colorForKey(r.key) }));
    _lastSegments = segments; // store for "Open chart"
    renderStackedBar(segments, total);

    // ---- Emit a structured snapshot so Compare can render side-by-side ----
    const snapshot = {
      slot,
      state: code,
      inputs: {
        filingStatus: latestInputs.filingStatus,
        income: inc,
        includeFederal: !!latestInputs.includeFederal,
        ltcg: latestInputs.ltcg
      },
      totals: {
        stateSubtotal: stateSum,
        federalSubtotal: fedSum,
        total,
        effectiveRate: total / Math.max(1, inc)
      },
      rows: {
        state: stateNumeric,
        federal: federalNumeric
      }
    };
    root.dispatchEvent(new CustomEvent('t1:breakdown-computed', { detail: snapshot, bubbles: true }));
  }

  function updateState(val) {
    const code = normalizeStateCode(val);

    // Read latest inputs from the form
    try {
      const form = document.querySelector('form[aria-label="Tax inputs"]');
      if (form) {
        const get = id => form.querySelector('#' + id);
        const incEl  = get('inc');
        const hvEl   = get('hv');
        const hoEl   = get('ho');
        const fsEl   = get('fs');
        const ssEl   = get('ss');
        const tsEl   = get('ts');
        const fedEl  = get('fed');
        const ltcgEl = get('ltcg');
        const parse = (v) => Number(String(v||'').replace(/[^0-9.-]/g,'')) || 0;

        latestInputs.income         = incEl  ? parse(incEl.value)  : latestInputs.income;
        latestInputs.homeValue      = hvEl   ? parse(hvEl.value)   : latestInputs.homeValue;
        latestInputs.homeowner      = hoEl   ? (hoEl.value === '1') : latestInputs.homeowner;
        latestInputs.filingStatus   = fsEl   ? (fsEl.value || 'single') : latestInputs.filingStatus;
        latestInputs.spendingShare  = ssEl   ? (+ssEl.value)           : latestInputs.spendingShare;
        latestInputs.taxableShare   = tsEl   ? (+tsEl.value)           : latestInputs.taxableShare;
        latestInputs.includeFederal = fedEl  ? (fedEl.value === '1')   : latestInputs.includeFederal;
        latestInputs.ltcg           = ltcgEl ? parse(ltcgEl.value)     : latestInputs.ltcg;
      }
    } catch {}

    if (!code) return;

    root.setAttribute('data-state', code);
    if (stateLabel) stateLabel.textContent = code;
    if (exportLink) exportLink.setAttribute('href', `/report?state=${code}`);
    if (compareLink) compareLink.setAttribute('href', buildCompareHref(code));

    requestAnimationFrame(() => computeDemoBreakdown(code));
  }

  // Map selects a new state
  window.addEventListener('t1:state', (e) => {
    const s = e.detail;
    if (!s) return;
    if (slot === 'solo') updateState(s);
  });

  // Inputs changed â†’ recompute current state (next frame)
  window.addEventListener('t1:inputs', (e) => {
    const d = e.detail || {};
    latestInputs.filingStatus   = d.filingStatus   ?? latestInputs.filingStatus;
    latestInputs.income         = d.income         ?? latestInputs.income;
    latestInputs.homeValue      = d.homeValue      ?? latestInputs.homeValue;
    latestInputs.homeowner      = (typeof d.homeowner === 'boolean') ? d.homeowner : latestInputs.homeowner;
    latestInputs.miles          = d.miles          ?? latestInputs.miles;
    latestInputs.mpg            = d.mpg            ?? latestInputs.mpg;
    latestInputs.spendingShare  = d.spendingShare  ?? latestInputs.spendingShare;
    latestInputs.taxableShare   = d.taxableShare   ?? latestInputs.taxableShare;
    latestInputs.includeFederal = (typeof d.includeFederal === 'boolean') ? d.includeFederal : latestInputs.includeFederal;
    latestInputs.ltcg           = d.ltcg           ?? latestInputs.ltcg;

    const cur = root.getAttribute('data-state') || stateLabel?.textContent || 'CA';
    requestAnimationFrame(() => computeDemoBreakdown(cur));
  });

  // Fallback: recompute on any input/change events from the inputs form to
  // guarantee instant updates even if the custom event path is interrupted.
  (function ensureInstantRecompute() {
    const form = document.querySelector('form[aria-label="Tax inputs"]');
    if (!form) return;
    const capture = () => {
      try {
        const get = (id) => form.querySelector('#' + id);
        const parse = (v) => Number(String(v||'').replace(/[^0-9.-]/g,'')) || 0;
        latestInputs.income         = get('inc')  ? parse(get('inc').value)  : latestInputs.income;
        latestInputs.homeValue      = get('hv')   ? parse(get('hv').value)   : latestInputs.homeValue;
        latestInputs.homeowner      = get('ho')   ? (get('ho').value === '1') : latestInputs.homeowner;
        latestInputs.filingStatus   = get('fs')   ? (get('fs').value || 'single') : latestInputs.filingStatus;
        latestInputs.spendingShare  = get('ss')   ? (+get('ss').value)           : latestInputs.spendingShare;
        latestInputs.taxableShare   = get('ts')   ? (+get('ts').value)           : latestInputs.taxableShare;
        latestInputs.includeFederal = get('fed')  ? (get('fed').value === '1')   : latestInputs.includeFederal;
        latestInputs.ltcg           = get('ltcg') ? parse(get('ltcg').value)     : latestInputs.ltcg;
      } catch {}
      const cur = root.getAttribute('data-state') || stateLabel?.textContent || 'CA';
      requestAnimationFrame(() => computeDemoBreakdown(cur));
    };
    form.addEventListener('input', capture, { passive: true });
    form.addEventListener('change', capture);
  })();

  // Compare slots support
  window.addEventListener('t1:state-left',  (e) => { if (slot === 'left')  updateState(e.detail); });
  window.addEventListener('t1:state-right', (e) => { if (slot === 'right') updateState(e.detail); });

  // Copy link (local toolbar)
  copyBtn?.addEventListener('click', async () => {
    try {
      await navigator.clipboard.writeText(location.href);
      copyBtn.textContent = 'Copied!';
      setTimeout(() => { copyBtn.textContent = 'Copy link'; }, 1200);
    } catch {}
  });

  // Open chart (pie modal)
  pieBtn?.addEventListener('click', () => {
    const code = root.getAttribute('data-state') || 'â€”';
    const html = buildPieHTML(`${code} â€” tax mix`, _lastSegments);
    window.dispatchEvent(new CustomEvent('t1:modal-open', { detail: { title: 'Tax composition', html } }));
  });

  // Initialize from URL (?fips=06 or ?state=CA), else use data-state
  try {
    const url  = new URL(location.href);
    const fips = url.searchParams.get('fips');
    const st   = url.searchParams.get('state');
    updateState(st || fips || root.getAttribute('data-state') || 'CA');
  } catch {
    updateState(root.getAttribute('data-state') || 'CA');
  }
})();
</script>

