---
/* Breakdown panel (bundled module import) */
const { initialState = 'CA', compareSlot } = Astro.props;
const slot = compareSlot ?? 'solo';
---
<div
  class="panel stack"
  data-t1-breakdown
  data-slot={slot}
  data-state={initialState}
>
  <div class="label">
    <strong>Breakdown</strong><span id="bd-state">{initialState}</span>
  </div>

  <div id="chart" class="bar" aria-label="Stacked tax burden bar"></div>

  <table id="tbl" class="table-full">
    <thead>
      <tr>
        <th>Category</th>
        <th class="text-right">Amount</th>
        <th class="text-right">%</th>
      </tr>
    </thead>
    <tbody></tbody>
    <tfoot>
      <tr>
        <th>Total</th>
        <th id="tot" class="text-right"></th>
        <th id="eff" class="text-right"></th>
      </tr>
    </tfoot>
  </table>

  <div class="label">
    <a class="badge" id="export" href={`/report?state=${initialState}`}>Export PDF</a>
  </div>
</div>

<!-- Small client script to listen for state change events and update this panel's UI/export link -->
<script type="module">
  (function(){
    const root = document.currentScript?.previousElementSibling;
    if (!root) return;
    const slot = root.getAttribute('data-slot') || 'solo';
    const stateLabel = root.querySelector('#bd-state');
    const exportLink = root.querySelector('#export');

    function updateState(s){
      root.setAttribute('data-state', s);
      if(stateLabel) stateLabel.textContent = s;
      if(exportLink) exportLink.setAttribute('href', `/report?state=${s}`);
    }

    // generic event that set any slot
    window.addEventListener('t1:state', (e)=>{
      const s = e.detail; if(!s) return; if(slot === 'solo') updateState(s);
    });

    window.addEventListener('t1:state-left', (e)=>{
      const s = e.detail; if(!s) return; if(slot === 'left') updateState(s);
    });
    window.addEventListener('t1:state-right', (e)=>{
      const s = e.detail; if(!s) return; if(slot === 'right') updateState(s);
    });

    // Also listen for a direct click/update API
    root.addEventListener('t1:set-state', (ev)=>{
      const s = ev.detail; if(s) updateState(s);
    });
  })();
</script>
