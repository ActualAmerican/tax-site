---
/* Pure Astro markup; browser wiring lives in a small client script below */
---
<form class="stack" aria-label="Tax inputs">
  <div class="label"><span>Filing status</span></div>
  <select id="fs" aria-label="Filing status">
    <option value="single" selected>Single</option>
    <option value="married">Married</option>
  </select>

  <div class="label"><span>Income ($)</span></div>
  <input id="inc" type="text" inputmode="numeric" pattern="[0-9,]*" value="60000" aria-label="Income in dollars" />


  <div class="label"><span>Homeowner?</span></div>
<div class="segmented" data-for="ho"></div>
<select id="ho" aria-label="Homeowner">
  <option value="1" selected>Yes</option>
  <option value="0">No (renter)</option>
</select>

  <div class="label"><span>Home value ($)</span></div>
  <input id="hv" type="text" inputmode="numeric" pattern="[0-9,]*" value="300000" aria-label="Home value in dollars" />
  <div class="muted-note">Used to estimate annual property tax (statewide effective rate).</div>

    <div class="grid">
    <div>
      <div class="label"><span>Miles/year</span></div>
      <input id="mi" type="text" inputmode="numeric" pattern="[0-9]*" value="12000" aria-label="Miles driven per year" />
    </div>
    <div>
      <div class="label"><span>MPG</span></div>
      <input id="mpg" type="text" inputmode="numeric" pattern="[0-9]*" value="28" aria-label="Vehicle miles per gallon" />
    </div>
  </div>

    <div class="grid">
    <div>
      <div class="label"><span>Spending share</span><span class="badge" id="ssb" aria-live="polite">60%</span></div>
      <input id="ss" type="range" min="0.2" max="0.95" step="0.01" value="0.60" aria-label="Spending share" />
    </div>
    <div>
      <div class="label"><span>Taxable share</span><span class="badge" id="tsb" aria-live="polite">55%</span></div>
      <input id="ts" type="range" min="0.2" max="0.95" step="0.01" value="0.55" aria-label="Taxable share" />
    </div>
  </div>

  <details class="disclosure">
    <summary class="label">Optional excise</summary>
    <div class="grid">
      <div>
        <div class="label"><span>Cig packs/week</span></div>
  <input id="cig" type="number" value="0" min="0" step="0.1" aria-label="Cigarette packs per week" />
      </div>
      <div>
        <div class="label"><span>Alcohol units/week</span></div>
  <input id="alc" type="number" value="0" min="0" step="1" aria-label="Alcohol units per week" />
      </div>
    </div>
  </details>

  <details class="disclosure">
    <summary class="label">Federal options</summary>
    <div class="grid">
            <div>
        <div class="label"><span>Include federal?</span></div>
        <div class="segmented" data-for="fed"></div>
        <select id="fed" aria-label="Include federal">
          <option value="1">Yes</option>
          <option value="0" selected>No</option>
        </select>
        <div class="muted-note">Adds Federal income, payroll, and LTCG (if set) to the breakdown.</div>
      </div>

            <div>
        <div class="label"><span>Long-term cap gains ($)</span></div>
        <input id="ltcg" type="text" value="0" aria-label="Long-term capital gains" />
        <div class="muted-note">Only affects the “LTCG” row when “Include federal” is on.</div>
      </div>
    </div>
  </details>
</form>

<script type="module">
/* Inputs client: live format, instant emit, segmented toggles */
(function () {
  const $ = (id) => document.getElementById(id);

  // --- Local URL helpers (avoid inline import issues) ------------------------
  function currentURL(){ try { return new URL(window.location.href); } catch { return null; } }
  function readInputsFromURL(u){
    const gp = (k) => u.searchParams.get(k);
    const pnum = (v) => Number(String(v||'').replace(/[^0-9.-]/g,'')) || 0;
    return {
      filingStatus: gp('fs') || 'single',
      income: gp('inc') ? pnum(gp('inc')) : 60000,
      homeowner: (gp('ho') ?? '1') === '1',
      homeValue: gp('hv') ? pnum(gp('hv')) : 300000,
      miles: gp('mi') ? +gp('mi') : 12000,
      mpg: gp('mpg') ? +gp('mpg') : 28,
      spendingShare: gp('ss') ? +gp('ss') : 0.6,
      taxableShare: gp('ts') ? +gp('ts') : 0.55,
      cigPacksPerWeek: gp('cig') ? +gp('cig') : 0,
      alcoholUnitsPerWeek: gp('alc') ? +gp('alc') : 0,
      includeFederal: (gp('fed') ?? '0') === '1',
      ltcg: gp('ltcg') ? pnum(gp('ltcg')) : 0,
    };
  }
  function writeInputsToURL(u, i){
    const sp = u.searchParams;
    const set = (k, v) => { if (v==null || v==='' || v===0) sp.delete(k); else sp.set(k, String(v)); };
    set('fs', i.filingStatus);
    set('inc', i.income|0);
    set('ho', i.homeowner ? '1' : '0');
    set('hv', i.homeValue|0);
    set('mi', i.miles);
    set('mpg', i.mpg);
    set('ss', i.spendingShare);
    set('ts', i.taxableShare);
    set('cig', i.cigPacksPerWeek || null);
    set('alc', i.alcoholUnitsPerWeek || null);
    set('fed', i.includeFederal ? '1' : '0');
    set('ltcg', i.ltcg || null);
    return u;
  }

  // ---- Number formatting + caret-preserving parser --------------------------
  function parseNum(v) {
    if (v == null) return 0;
    return Number(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  const nf = new Intl.NumberFormat('en-US');
  function fmtNum(n){ return nf.format(n|0); }

  function attachLiveFormatter(inputEl) {
    if (!inputEl) return;
    const handler = (e) => {
      const el = e.target;
      const start = el.selectionStart;
      const before = el.value.slice(0, start);
      const offsetDigits = (before.match(/[0-9]/g) || []).length;

      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';

      let seen = 0, pos = 0;
      while (pos < el.value.length && seen < offsetDigits) {
        if (/[0-9]/.test(el.value[pos])) seen++;
        pos++;
      }
      try { el.setSelectionRange(pos, pos); } catch {}
    };
    inputEl.addEventListener('input', handler);
    inputEl.addEventListener('keyup', handler);
    inputEl.addEventListener('change', handler);

    // Extra: while focused, enforce formatting every frame to survive other
    // scripts tweaking value order. Stops on blur.
    let running = false;
    const tick = () => {
      if (!running) return;
      const el = inputEl;
      const raw = parseNum(el.value);
      const formatted = raw ? fmtNum(raw) : '';
      if (el.value !== formatted) {
        const start = el.selectionStart;
        const before = el.value.slice(0, start);
        const offsetDigits = (before.match(/[0-9]/g) || []).length;
        el.value = formatted;
        let seen=0,pos=0; while(pos<el.value.length && seen<offsetDigits){ if(/[0-9]/.test(el.value[pos])) seen++; pos++; }
        try { el.setSelectionRange(pos,pos); } catch {}
      }
      requestAnimationFrame(tick);
    };
    inputEl.addEventListener('focus', () => { if (!running) { running = true; requestAnimationFrame(tick); } });
    inputEl.addEventListener('blur',  () => { running = false; });
  }

  // ---- Initialize controls from URL (fallback to current DOM defaults) ------
  const init = (()=>{ const u = currentURL(); return u ? readInputsFromURL(u) : {
    filingStatus: 'single', income: 60000, homeowner:true, homeValue:300000,
    miles:12000, mpg:28, spendingShare:0.6, taxableShare:0.55, cigPacksPerWeek:0, alcoholUnitsPerWeek:0,
    includeFederal:false, ltcg:0
  }; })();

  // Push URL-derived values into controls (so UI reflects URL on first paint)
  if ($('fs'))  $('fs').value  = init.filingStatus;
  if ($('inc')) $('inc').value = fmtNum(init.income);
  if ($('ho'))  $('ho').value  = init.homeowner ? '1' : '0';
  if ($('hv'))  $('hv').value  = fmtNum(init.homeValue);
  if ($('mi'))  $('mi').value  = String(init.miles);
  if ($('mpg')) $('mpg').value = String(init.mpg);
  if ($('ss'))  $('ss').value  = String(init.spendingShare);
  if ($('ts'))  $('ts').value  = String(init.taxableShare);
  const _ssb = document.getElementById('ssb'); if (_ssb) _ssb.textContent = Math.round(init.spendingShare * 100) + '%';
  const _tsb = document.getElementById('tsb'); if (_tsb) _tsb.textContent = Math.round(init.taxableShare  * 100) + '%';
  if ($('cig')) $('cig').value = String(init.cigPacksPerWeek);
  if ($('alc')) $('alc').value = String(init.alcoholUnitsPerWeek);
  if ($('fed')) $('fed').value = init.includeFederal ? '1' : '0';
  if ($('ltcg')) $('ltcg').value = fmtNum(init.ltcg);

  // ---- State (kept simple and flat) -----------------------------------------
  const state = { ...init };

  // ---- Emit helper (updates URL, then notifies listeners) -------------------
  function emit() {
    const cu = currentURL(); if (!cu) return;
    const u = writeInputsToURL(cu, state);
    history.replaceState({}, '', u);
    // Microtask so live-formatters settle before recompute
    queueMicrotask(() => {
      window.dispatchEvent(new CustomEvent('t1:inputs', { detail: { ...state } }));
    });
  }

  // ---- Segmented toggle enhancement (hides original <select>) ---------------
  function enhanceSegmented(container) {
    if (!container) return;
    const selectId = container.getAttribute('data-for');
    const sel = $(selectId);
    if (!sel) return;

    container.setAttribute('data-enhanced', '1');
    container.innerHTML = `
      <div role="group" class="seg-buttons">
        <button type="button" data-val="1" aria-pressed="${sel.value==='1'}">Yes</button>
        <button type="button" data-val="0" aria-pressed="${sel.value==='0'}">No</button>
      </div>
    `;
    // Hide the original select to avoid duplicate controls (kept in DOM for a11y/fallback)
    try { sel.style.display = 'none'; } catch {}

    container.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-val]');
      if (!btn) return;
      const v = btn.getAttribute('data-val');
      sel.value = v;
      container.querySelectorAll('button[data-val]').forEach(b => {
        b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
      });
      if (selectId === 'ho')  state.homeowner      = (v === '1');
      if (selectId === 'fed') state.includeFederal = (v === '1');
      emit();
    });
  }

  // ---- Wire up events (instant update on input) -----------------------------
  $('fs')?.addEventListener('change', e => { state.filingStatus = e.target.value; emit(); });

  const incEl = $('inc'); attachLiveFormatter(incEl);
  incEl?.addEventListener('input',  e => { state.income = parseNum(e.target.value); emit(); });

  const hvEl  = $('hv');  attachLiveFormatter(hvEl);
  hvEl?.addEventListener('input',   e => { state.homeValue = parseNum(e.target.value); emit(); });

  const miEl = $('mi'); attachLiveFormatter(miEl);
  miEl?.addEventListener('input',  e => { state.miles = +parseNum(e.target.value) || 0; emit(); });

  const mpgEl = $('mpg'); attachLiveFormatter(mpgEl);
  mpgEl?.addEventListener('input', e => { state.mpg   = +parseNum(e.target.value) || 1; emit(); });

  $('ss')?.addEventListener('input',  e => {
    state.spendingShare = +e.target.value;
    const b = document.getElementById('ssb');
    if (b) b.textContent = Math.round(state.spendingShare * 100) + '%';
    emit();
  });

  $('ts')?.addEventListener('input',  e => {
    state.taxableShare  = +e.target.value;
    const b = document.getElementById('tsb');
    if (b) b.textContent = Math.round(state.taxableShare * 100) + '%';
    emit();
  });

  $('cig')?.addEventListener('input', e => { state.cigPacksPerWeek = +e.target.value || 0; emit(); });
  $('alc')?.addEventListener('input', e => { state.alcoholUnitsPerWeek = +e.target.value || 0; emit(); });

  $('fed')?.addEventListener('change', e => { state.includeFederal = (e.target.value === '1'); emit(); });

  const ltcgEl = $('ltcg'); attachLiveFormatter(ltcgEl);
  ltcgEl?.addEventListener('input', e => { state.ltcg = parseNum(e.target.value); emit(); });

  // Enhance Yes/No segmented controls and hide the selects
  document.querySelectorAll('.segmented[data-for]').forEach(enhanceSegmented);

  // First paint (normalize text values and emit an initial state)
  if (incEl) incEl.value = fmtNum(state.income);
  if (hvEl)  hvEl.value  = fmtNum(state.homeValue);
  if (ltcgEl)ltcgEl.value= fmtNum(state.ltcg);
  // Kick a microtask/RAF pass to ensure formatting has the last word
  requestAnimationFrame(() => {
    if (incEl) incEl.dispatchEvent(new Event('input', { bubbles:false }));
    if (hvEl)  hvEl.dispatchEvent(new Event('input', { bubbles:false }));
    if (ltcgEl)ltcgEl.dispatchEvent(new Event('input', { bubbles:false }));
  });

  // Also format immediately from URL without requiring focus/typing
  (function formatOnLoad(){
    const fields = [incEl, hvEl, miEl, mpgEl, ltcgEl];
    for (const el of fields) {
      if (!el) continue;
      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';
    }
  })();
  emit();

  // Defensive: capture-level formatter for dollar inputs to ensure commas even
  // if any other listener interferes. Also keeps instant recompute in sync.
  document.addEventListener('input', (ev) => {
    const el = ev.target;
    if (!(el && el.id && (el.id==='inc' || el.id==='hv' || el.id==='ltcg'))) return;
    const start = el.selectionStart;
    const before = el.value.slice(0, start);
    const offsetDigits = (before.match(/[0-9]/g) || []).length;
    const raw = parseNum(el.value);
    el.value = raw ? fmtNum(raw) : '';
    let seen = 0, pos = 0;
    while (pos < el.value.length && seen < offsetDigits) { if (/[0-9]/.test(el.value[pos])) seen++; pos++; }
    try { el.setSelectionRange(pos, pos); } catch {}
  }, true);
})();
</script>
