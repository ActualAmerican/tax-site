---
/* Pure Astro markup; browser wiring lives in a small client script below */
---
<form class="stack" aria-label="Tax inputs">
  <div class="label"><span>Filing status</span></div>
  <select id="fs" aria-label="Filing status">
    <option value="single" selected>Single</option>
    <option value="married">Married</option>
  </select>

  <div class="label"><span>Income ($)</span></div>
  <input id="inc" type="text" value="60000" aria-label="Income in dollars" />

  <div class="label"><span>Homeowner?</span></div>
  <select id="ho" aria-label="Homeowner">
    <option value="1" selected>Yes</option>
    <option value="0">No (renter)</option>
  </select>

  <div class="label"><span>Home value ($)</span></div>
  <input id="hv" type="text" value="300000" aria-label="Home value in dollars" />

  <div class="grid">
    <div>
      <div class="label"><span>Miles/year</span></div>
  <input id="mi" type="text" value="12000" aria-label="Miles driven per year" />
    </div>
    <div>
      <div class="label"><span>MPG</span></div>
  <input id="mpg" type="text" value="28" aria-label="Vehicle miles per gallon" />
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="label"><span>Spending share</span><span class="badge" id="ssb">60%</span></div>
  <input id="ss" type="range" min="0.2" max="0.95" step="0.01" value="0.60" aria-label="Spending share" />
    </div>
    <div>
      <div class="label"><span>Taxable share</span><span class="badge" id="tsb">55%</span></div>
  <input id="ts" type="range" min="0.2" max="0.95" step="0.01" value="0.55" aria-label="Taxable share" />
    </div>
  </div>

  <details>
    <summary class="label">Optional excise</summary>
    <div class="grid">
      <div>
        <div class="label"><span>Cig packs/week</span></div>
  <input id="cig" type="number" value="0" min="0" step="0.1" aria-label="Cigarette packs per week" />
      </div>
      <div>
        <div class="label"><span>Alcohol units/week</span></div>
  <input id="alc" type="number" value="0" min="0" step="1" aria-label="Alcohol units per week" />
      </div>
    </div>
  </details>

  <details>
    <summary class="label">Federal options</summary>
    <div class="grid">
      <div>
        <div class="label"><span>Include federal?</span></div>
        <select id="fed" aria-label="Include federal taxes">
          <option value="0" selected>No</option>
          <option value="1">Yes</option>
        </select>
      </div>
      <div>
        <div class="label"><span>Long-term cap gains ($)</span></div>
  <input id="ltcg" type="text" value="0" aria-label="Long-term capital gains" />
      </div>
    </div>
  </details>
</form>

<script type="module">
  // document.currentScript is null when this module is executed as a JS module
  // (type="module"), so fall back to querying the form by its aria label.
  const root = (document.currentScript && document.currentScript.parentElement) || document.querySelector('form[aria-label="Tax inputs"]');

  const q = (id) => root.querySelector('#'+id);
  const state = {
    filingStatus: 'single',
    income: 60000,
    homeowner: true,
    homeValue: 300000,
    miles: 12000,
    mpg: 28,
    spendingShare: 0.60,
    taxableShare: 0.55,
    cigPacksPerWeek: 0,
    alcoholUnitsPerWeek: 0,
    includeFederal: false,
    ltcg: 0
  };

  const fmtPct = (x)=> (x*100|0) + '%';
  const parseNum = (v) => {
    if (v == null) return 0;
    try { return Number(String(v).replace(/[^0-9.\-]/g, '')) || 0; } catch (e) { return 0; }
  };
  const fmtNum = (n) => {
    try { return (new Intl.NumberFormat()).format(Math.round(n)); } catch (e) { return String(n); }
  };
  // Live-format an input element with commas while preserving caret position
  function attachLiveFormatter(el) {
    if (!el) return;
    el.addEventListener('input', (ev) => {
      const cur = ev.target;
      const raw = String(cur.value || '');
      // count digits before caret
      const selStart = cur.selectionStart || raw.length;
      const digitsBefore = (raw.slice(0, selStart).match(/\d/g) || []).length;
      // produce formatted string from digits only
      const digits = raw.replace(/\D/g, '') || '0';
      const formatted = (new Intl.NumberFormat()).format(Number(digits));
      cur.value = formatted;
      // set caret to position correlated with digitsBefore
      let pos = 0, seen = 0;
      for (let i = 0; i < formatted.length; i++) {
        if (/[0-9]/.test(formatted[i])) seen++;
        pos = i + 1;
        if (seen >= digitsBefore) break;
      }
      try { cur.setSelectionRange(pos, pos); } catch (e) {}
    });
  }
  const emit = () => window.dispatchEvent(new CustomEvent('t1:inputs', { detail: { ...state } }));

  q('fs').addEventListener('change', (e)=>{ state.filingStatus = e.target.value; emit(); });
  // Number inputs: only emit on change/blur or when the user presses Enter.
  const incEl = q('inc');
  if (incEl) {
    incEl.addEventListener('change',  (e)=>{ state.income = parseNum(e.target.value); e.target.value = fmtNum(state.income); emit(); });
    incEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { state.income = parseNum(e.target.value); e.target.value = fmtNum(state.income); emit(); e.target.blur(); } });
    incEl.addEventListener('focus', (e)=>{ e.target.value = String(parseNum(e.target.value) || '') });
    // format initial
    incEl.value = fmtNum(state.income);
    attachLiveFormatter(incEl);
  }
  q('ho').addEventListener('change',  (e)=>{ state.homeowner = e.target.value === '1'; emit(); });
  const hvEl = q('hv');
  if (hvEl) {
    hvEl.addEventListener('change',   (e)=>{ state.homeValue = parseNum(e.target.value); e.target.value = fmtNum(state.homeValue); emit(); });
    hvEl.addEventListener('keydown',  (e)=>{ if (e.key === 'Enter') { state.homeValue = parseNum(e.target.value); e.target.value = fmtNum(state.homeValue); emit(); e.target.blur(); } });
    hvEl.addEventListener('focus', (e)=>{ e.target.value = String(parseNum(e.target.value) || '') });
    hvEl.value = fmtNum(state.homeValue);
    attachLiveFormatter(hvEl);
  }
  const miEl = q('mi');
  if (miEl) {
    miEl.addEventListener('change',   (e)=>{ state.miles = parseNum(e.target.value); e.target.value = fmtNum(state.miles); emit(); });
    miEl.addEventListener('keydown',  (e)=>{ if (e.key === 'Enter') { state.miles = parseNum(e.target.value); e.target.value = fmtNum(state.miles); emit(); e.target.blur(); } });
    miEl.addEventListener('focus', (e)=>{ e.target.value = String(parseNum(e.target.value) || '') });
    miEl.value = fmtNum(state.miles);
    attachLiveFormatter(miEl);
  }
  const mpgEl = q('mpg');
  if (mpgEl) {
    mpgEl.addEventListener('change',  (e)=>{ state.mpg = parseNum(e.target.value) || 1; e.target.value = fmtNum(state.mpg); emit(); });
    mpgEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { state.mpg = parseNum(e.target.value) || 1; e.target.value = fmtNum(state.mpg); emit(); e.target.blur(); } });
    mpgEl.addEventListener('focus', (e)=>{ e.target.value = String(parseNum(e.target.value) || '') });
    mpgEl.value = fmtNum(state.mpg);
    attachLiveFormatter(mpgEl);
  }

  const ss = q('ss'), ts = q('ts');
  const ssb = q('ssb'), tsb = q('tsb');
  // Ranges are live and should emit on input for immediate feedback
  ss.addEventListener('input', (e)=>{ state.spendingShare = +e.target.value; ssb.textContent = fmtPct(state.spendingShare); emit(); });
  ts.addEventListener('input', (e)=>{ state.taxableShare  = +e.target.value; tsb.textContent = fmtPct(state.taxableShare); emit(); });

  // Optional excise numeric inputs: change/Enter/blur to commit
  q('cig').addEventListener('change',  (e)=>{ state.cigPacksPerWeek = parseNum(e.target.value) || 0; emit(); });
  q('cig').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { state.cigPacksPerWeek = parseNum(e.target.value) || 0; emit(); e.target.blur(); } });
  q('alc').addEventListener('change',  (e)=>{ state.alcoholUnitsPerWeek = parseNum(e.target.value) || 0; emit(); });
  q('alc').addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { state.alcoholUnitsPerWeek = parseNum(e.target.value) || 0; emit(); e.target.blur(); } });
  q('fed').addEventListener('change', (e)=>{ state.includeFederal = e.target.value === '1'; emit(); });
  const ltcgEl = q('ltcg');
  if (ltcgEl) {
    ltcgEl.addEventListener('change', (e)=>{ state.ltcg = parseNum(e.target.value) || 0; e.target.value = fmtNum(state.ltcg); emit(); });
    ltcgEl.addEventListener('keydown', (e)=>{ if (e.key === 'Enter') { state.ltcg = parseNum(e.target.value) || 0; e.target.value = fmtNum(state.ltcg); emit(); e.target.blur(); } });
    ltcgEl.addEventListener('focus', (e)=>{ e.target.value = String(parseNum(e.target.value) || '') });
    ltcgEl.value = fmtNum(state.ltcg);
    attachLiveFormatter(ltcgEl);
  }

  // initial render
  emit();
</script>
