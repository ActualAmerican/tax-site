---
import ScopeSelector from './ScopeSelector.astro';
import LocalityPicker from './LocalityPicker.astro';
import InputsLocal from './InputsLocal.astro';
import InputsState from './InputsState.astro';
import InputsFederal from './InputsFederal.astro';
---

<form class="inputs-panel stack" aria-label="Tax inputs">
  <ScopeSelector />
  <section class="scope-card scope-card--local" data-scope-card="local" hidden aria-hidden="true">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--local">Local</span>
        <h3 class="scope-card__heading">Local taxes</h3>
      </div>
      <p class="scope-card__desc">City, county, and district add-ons.</p>
    </header>
    <LocalityPicker />
    <InputsLocal />
  </section>

  <section class="scope-card scope-card--state" data-scope-card="state" hidden aria-hidden="true">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--state">State</span>
        <h3 class="scope-card__heading">State taxes</h3>
      </div>
      <p class="scope-card__desc">Income, property, sales, motor fuel, and excise.</p>
    </header>
    <InputsState />
  </section>

  <section class="scope-card scope-card--federal" data-scope-card="federal" hidden aria-hidden="true">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--federal">Federal</span>
        <h3 class="scope-card__heading">Federal taxes</h3>
      </div>
      <p class="scope-card__desc">Income, payroll, and capital gains layers.</p>
    </header>
    <InputsFederal />
  </section>
</form>

<script type="module">
/* Inputs client: live format, instant emit, toggle groups + scopes */
(function () {
  const $ = (id) => document.getElementById(id);

  const win = typeof window !== 'undefined' ? window : undefined;
  const shareCtrl = win && typeof win.__T1_SHARE__ === 'object' ? win.__T1_SHARE__ : null;
  const shareUtils = win && win.__T1_SHARE_UTILS__ ? win.__T1_SHARE_UTILS__ : null;
  const controller = win && win.__T1_CONTROLLER__ ? win.__T1_CONTROLLER__ : null;
  const PACK_VERSION = (() => {
    if (!win) return null;
    if (shareCtrl && typeof shareCtrl.version === 'string' && shareCtrl.version) return shareCtrl.version;
    if (typeof win.__T1_PACK_VERSION__ === 'string' && win.__T1_PACK_VERSION__) return win.__T1_PACK_VERSION__;
    try {
      const seeded = win.__T1_PACK__ || win.__t1_pack;
      const ver = seeded?.registry?.pack_version;
      return typeof ver === 'string' && ver.trim() ? ver : null;
    } catch {
      return null;
    }
  })();

  const shareDefaults = () => ({
    state: { fips: null, code: null },
    inputs: {
      filingStatus: 'single',
      income: 60000,
      homeowner: true,
      homeValue: 300000,
      miles: 12000,
      mpg: 28,
      spendingShare: 0.6,
      taxableShare: 0.55,
      cigPacksPerWeek: 0,
      alcoholUnitsPerWeek: 0,
      includeFederal: true,
      ltcg: 0,
    },
    scope: { local: false, state: false, federal: false },
    local: { zip: null, countyFips: null, toggles: 0 },
    version: PACK_VERSION || null,
  });

  const normalizeStateFipsValue = (value) => {
    if (value == null) return null;
    const digits = String(value).trim().replace(/\D+/g, '');
    if (!digits) return null;
    return digits.padStart(2, '0').slice(0, 2);
  };

  const normalizeCountyFipsValue = (value) => {
    if (value == null) return null;
    const digits = String(value).trim().replace(/\D+/g, '');
    if (!digits) return null;
    return digits.padStart(5, '0').slice(0, 5);
  };

  function resolveShareModel() {
    try {
      if (shareCtrl && typeof shareCtrl.getModel === 'function') {
        const model = shareCtrl.getModel();
        if (model) return model;
      }
    } catch (_err) {}
    if (win && win.__T1_SHARE_MODEL__) {
      try {
        if (shareUtils && typeof shareUtils.mergeModel === 'function') {
          return shareUtils.mergeModel(win.__T1_SHARE_MODEL__, {}, { packVersion: PACK_VERSION || undefined });
        }
        return { ...win.__T1_SHARE_MODEL__ };
      } catch (_err) {
        return win.__T1_SHARE_MODEL__;
      }
    }
    if (shareUtils && typeof shareUtils.createDefaultModel === 'function') {
      return shareUtils.createDefaultModel({ packVersion: PACK_VERSION || undefined });
    }
    return shareDefaults();
  }

  let shareModel = resolveShareModel();
  if (win) win.__T1_SHARE_MODEL__ = shareModel;
  let controllerLocalScope =
    (controller && typeof controller.getLocalScope === 'function' && controller.getLocalScope()) ||
    (controller && controller.localScope ? { ...controller.localScope } : null);
  if (controllerLocalScope) {
    controllerLocalScope = {
      ...controllerLocalScope,
      stateFips: normalizeStateFipsValue(controllerLocalScope.stateFips),
      countyFips: normalizeCountyFipsValue(controllerLocalScope.countyFips),
    };
  }

  const resolveLocalStateFips = (detail = {}) =>
    normalizeStateFipsValue(detail.stateFips) ||
    (controllerLocalScope && normalizeStateFipsValue(controllerLocalScope.stateFips)) ||
    normalizeStateFipsValue(state.locality?.stateFips) ||
    normalizeStateFipsValue(shareModel.state?.fips) ||
    null;

  const syncGeoSelectionFromLocal = (countyFips, stateFips, origin = 'inputs-locality') => {
    if (!controller || typeof controller.setGeoSelection !== 'function') return;
    const normalizedCounty = normalizeCountyFipsValue(countyFips);
    if (normalizedCounty && scopeState.local) {
      const normalizedState = normalizeStateFipsValue(stateFips);
      if (!normalizedState) return;
      controller.setGeoSelection(
        { layer: 'county', stateFips: normalizedState, countyFips: normalizedCounty },
        { origin, schedule: false },
      );
      return;
    }
    if (!normalizedCounty) {
      controller.setGeoSelection(
        { layer: 'state', countyFips: null },
        { origin, schedule: false },
      );
    }
  };

  const scopeState = { ...shareModel.scope };
  let lastFederalPreference = shareModel.inputs.includeFederal;
  const selectorRoot = document.querySelector('[data-component="scope-selector"]');
  const scopeButtons = selectorRoot ? Array.from(selectorRoot.querySelectorAll('button[data-scope]')) : [];
  const localButton = selectorRoot ? selectorRoot.querySelector('button[data-scope="local"]') : null;
  let hasState = !!(shareModel.state && shareModel.state.fips);
  let userInteractedLocal = false;

  if (selectorRoot) {
    selectorRoot.setAttribute('data-local', scopeState.local ? '1' : '0');
    selectorRoot.setAttribute('data-state', scopeState.state ? '1' : '0');
    selectorRoot.setAttribute('data-federal', scopeState.federal ? '1' : '0');
  }

  const FIPS_TO_CODE = {
    '01':'AL','02':'AK','04':'AZ','05':'AR','06':'CA','08':'CO','09':'CT','10':'DE','11':'DC','12':'FL','13':'GA',
    '15':'HI','16':'ID','17':'IL','18':'IN','19':'IA','20':'KS','21':'KY','22':'LA','23':'ME','24':'MD','25':'MA',
    '26':'MI','27':'MN','28':'MS','29':'MO','30':'MT','31':'NE','32':'NV','33':'NH','34':'NJ','35':'NM','36':'NY',
    '37':'NC','38':'ND','39':'OH','40':'OK','41':'OR','42':'PA','44':'RI','45':'SC','46':'SD','47':'TN','48':'TX',
    '49':'UT','50':'VT','51':'VA','53':'WA','54':'WV','55':'WI','56':'WY','72':'PR'
  };

  function parseNum(v) {
    if (v == null) return 0;
    return Number(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  const nf = new Intl.NumberFormat('en-US');
  function fmtNum(n) { return nf.format(n | 0); }

  let fallbackTimer = 0;
  let fallbackLastURL = typeof location !== 'undefined' ? location.href : '';

  function scheduleFallbackURLUpdate(delay = 150) {
    if (!win) return;
    if (fallbackTimer) win.clearTimeout(fallbackTimer);
    fallbackTimer = win.setTimeout(() => {
      try {
        const encoded =
          shareUtils && typeof shareUtils.encode === 'function'
            ? shareUtils
                .encode(shareModel, {
                  baseUrl: location.href,
                  packVersion: PACK_VERSION || undefined,
                })
                .toString()
            : null;
        if (encoded && encoded !== fallbackLastURL) {
          history.replaceState(history.state ?? {}, '', encoded);
          fallbackLastURL = encoded;
        }
      } catch (err) {
        try { console.warn('inputs: fallback permalink update failed', err); } catch (_e) {}
      }
      fallbackTimer = 0;
    }, delay);
  }

  function updateShareModel(patch = {}, opts = {}) {
    try {
      if (shareCtrl && typeof shareCtrl.setModel === 'function') {
        shareModel = shareCtrl.setModel(patch);
        const delay = typeof opts.delay === 'number' ? opts.delay : 150;
        if (opts.push) {
          shareCtrl.scheduleURLUpdate?.({ push: true, state: opts.state, delay: 0 });
        } else {
          shareCtrl.scheduleURLUpdate?.({ delay });
        }
        return shareModel;
      }
    } catch (err) {
      try { console.warn('inputs: share controller merge failed', err); } catch (_e) {}
    }
    if (shareUtils && typeof shareUtils.mergeModel === 'function') {
      shareModel = shareUtils.mergeModel(shareModel, patch, { packVersion: PACK_VERSION || undefined });
    } else {
      const next = {
        state: { ...(shareModel.state || {}) },
        inputs: { ...(shareModel.inputs || {}) },
        scope: { ...(shareModel.scope || {}) },
        local: { ...(shareModel.local || {}) },
        version: shareModel.version ?? null,
      };
      if (patch.state) next.state = { ...next.state, ...patch.state };
      if (patch.inputs) next.inputs = { ...next.inputs, ...patch.inputs };
      if (patch.scope) next.scope = { ...next.scope, ...patch.scope };
      if (patch.local) next.local = { ...next.local, ...patch.local };
      if (patch.version !== undefined) next.version = patch.version;
      shareModel = next;
    }
    if (win) win.__T1_SHARE_MODEL__ = shareModel;
    scheduleFallbackURLUpdate(typeof opts.delay === 'number' ? opts.delay : 150);
    return shareModel;
  }

  function attachLiveFormatter(inputEl) {
    if (!inputEl) return;
    const handler = (e) => {
      const el = e.target;
      const start = el.selectionStart;
      const before = el.value.slice(0, start);
      const offsetDigits = (before.match(/[0-9]/g) || []).length;

      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';

      let seen = 0;
      let pos = 0;
      while (pos < el.value.length && seen < offsetDigits) {
        if (/[0-9]/.test(el.value[pos])) seen++;
        pos++;
      }
      try { el.setSelectionRange(pos, pos); } catch {}
    };
    inputEl.addEventListener('input', handler);
    inputEl.addEventListener('keyup', handler);
    inputEl.addEventListener('change', handler);

    let running = false;
    const tick = () => {
      if (!running) return;
      const el = inputEl;
      const raw = parseNum(el.value);
      const formatted = raw ? fmtNum(raw) : '';
      if (el.value !== formatted) {
        const start = el.selectionStart;
        const before = el.value.slice(0, start);
        const offsetDigits = (before.match(/[0-9]/g) || []).length;
        el.value = formatted;
        let seen = 0;
        let pos = 0;
        while (pos < el.value.length && seen < offsetDigits) {
          if (/[0-9]/.test(el.value[pos])) seen++;
          pos++;
        }
        try { el.setSelectionRange(pos, pos); } catch {}
      }
      requestAnimationFrame(tick);
    };
    inputEl.addEventListener('focus', () => { if (!running) { running = true; requestAnimationFrame(tick); } });
    inputEl.addEventListener('blur', () => { running = false; });
  }

  const init = { ...shareModel.inputs };

  if ($('fs')) $('fs').value = init.filingStatus;
  if ($('inc')) $('inc').value = fmtNum(init.income);
  if ($('ho')) $('ho').value = init.homeowner ? '1' : '0';
  if ($('hv')) $('hv').value = fmtNum(init.homeValue);
  if ($('mi')) $('mi').value = String(init.miles);
  if ($('mpg')) $('mpg').value = String(init.mpg);
  if ($('ss')) $('ss').value = String(init.spendingShare);
  if ($('ts')) $('ts').value = String(init.taxableShare);
  if ($('cig')) $('cig').value = String(init.cigPacksPerWeek);
  if ($('alc')) $('alc').value = String(init.alcoholUnitsPerWeek);
  if ($('fed')) $('fed').value = init.includeFederal ? '1' : '0';
  if ($('ltcg')) $('ltcg').value = fmtNum(init.ltcg);

  const ssBadge = document.getElementById('ssb');
  if (ssBadge) ssBadge.textContent = Math.round(init.spendingShare * 100) + '%';
  const tsBadge = document.getElementById('tsb');
  if (tsBadge) tsBadge.textContent = Math.round(init.taxableShare * 100) + '%';

  const state = { ...init };
  state.scopes = { ...scopeState };
  state.locality = {
    zip: shareModel.local.zip || null,
    fipsCounty: shareModel.local.countyFips || null,
    countyFips: shareModel.local.countyFips || null,
    state: shareModel.state.code || null,
    stateFips: shareModel.state.fips || null,
  };
  lastFederalPreference = state.includeFederal;

  const toggleControllers = new Map();

  function emit() {
    state.scopes = { ...scopeState };
    const localityDetail = { ...(state.locality || {}) };
    const patch = {
      inputs: {
        filingStatus: state.filingStatus,
        income: state.income,
        homeowner: state.homeowner,
        homeValue: state.homeValue,
        miles: state.miles,
        mpg: state.mpg,
        spendingShare: state.spendingShare,
        taxableShare: state.taxableShare,
        includeFederal: state.includeFederal,
        ltcg: state.ltcg,
        cigPacksPerWeek: state.cigPacksPerWeek,
        alcoholUnitsPerWeek: state.alcoholUnitsPerWeek,
      },
      scope: { ...scopeState },
      local: {
        zip: localityDetail.zip ?? null,
        countyFips: localityDetail.fipsCounty ?? localityDetail.countyFips ?? null,
        toggles:
          (controllerLocalScope && typeof controllerLocalScope.toggles === 'number'
            ? controllerLocalScope.toggles
            : shareModel.local?.toggles ?? 0),
      },
    };
    shareModel = updateShareModel(patch);
    queueMicrotask(() => {
      window.dispatchEvent(
        new CustomEvent('t1:inputs', {
          detail: {
            ...state,
            scopes: { ...scopeState },
            locality: localityDetail,
          },
        }),
      );
    });
  }

  function initToggleGroup(targetId, updater) {
    const hidden = $(targetId);
    const container = document.querySelector(`.toggle-group[data-target="${targetId}"]`);
    if (!hidden || !container) return;
    const buttons = Array.from(container.querySelectorAll('button[data-value]'));
    if (!buttons.length) return;

    const activate = (value, shouldEmit = true) => {
      hidden.value = value;
      buttons.forEach((btn) => {
        const isActive = btn.getAttribute('data-value') === value;
        btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
        btn.tabIndex = isActive ? 0 : -1;
        btn.classList.toggle('is-active', isActive);
      });
      if (typeof updater === 'function') updater(value);
      if (shouldEmit) emit();
    };

    container.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-value]');
      if (!btn) return;
      const value = btn.getAttribute('data-value');
      if (!value) return;
      activate(value);
      btn.focus();
    });

    container.addEventListener('keydown', (ev) => {
      const key = ev.key;
      if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(key)) return;
      ev.preventDefault();
      const currentIndex = buttons.findIndex((btn) => btn.getAttribute('aria-checked') === 'true');
      let nextIndex = currentIndex >= 0 ? currentIndex : 0;
      if (key === 'ArrowLeft') nextIndex = (nextIndex - 1 + buttons.length) % buttons.length;
      if (key === 'ArrowRight') nextIndex = (nextIndex + 1) % buttons.length;
      if (key === 'Home') nextIndex = 0;
      if (key === 'End') nextIndex = buttons.length - 1;
      const next = buttons[nextIndex];
      if (!next) return;
      activate(next.getAttribute('data-value'));
      next.focus();
    });

    activate(hidden.value || buttons[0].getAttribute('data-value'), false);
    toggleControllers.set(targetId, { activate });
  }

  document.getElementById('fs')?.addEventListener('change', (e) => {
    state.filingStatus = e.target.value;
    emit();
  });

  const incEl = $('inc'); attachLiveFormatter(incEl);
  incEl?.addEventListener('input', (e) => { state.income = parseNum(e.target.value); emit(); });

  const hvEl = $('hv'); attachLiveFormatter(hvEl);
  hvEl?.addEventListener('input', (e) => { state.homeValue = parseNum(e.target.value); emit(); });

  const miEl = $('mi'); attachLiveFormatter(miEl);
  miEl?.addEventListener('input', (e) => { state.miles = +parseNum(e.target.value) || 0; emit(); });

  const mpgEl = $('mpg'); attachLiveFormatter(mpgEl);
  mpgEl?.addEventListener('input', (e) => { state.mpg = +parseNum(e.target.value) || 1; emit(); });

  $('ss')?.addEventListener('input', (e) => {
    state.spendingShare = +e.target.value;
    if (ssBadge) ssBadge.textContent = Math.round(state.spendingShare * 100) + '%';
    emit();
  });

  $('ts')?.addEventListener('input', (e) => {
    state.taxableShare = +e.target.value;
    if (tsBadge) tsBadge.textContent = Math.round(state.taxableShare * 100) + '%';
    emit();
  });

  $('cig')?.addEventListener('input', (e) => { state.cigPacksPerWeek = +e.target.value || 0; emit(); });
  $('alc')?.addEventListener('input', (e) => { state.alcoholUnitsPerWeek = +e.target.value || 0; emit(); });

  const ltcgEl = $('ltcg'); attachLiveFormatter(ltcgEl);
  ltcgEl?.addEventListener('input', (e) => { state.ltcg = parseNum(e.target.value); emit(); });

  initToggleGroup('ho', (value) => { state.homeowner = (value === '1'); });
  initToggleGroup('fed', (value) => {
    const active = value === '1';
    state.includeFederal = active;
    lastFederalPreference = active;
    if ($('fed')) $('fed').value = active ? '1' : '0';
  });

  function updateSelectorChips() {
    if (!selectorRoot) return;
    selectorRoot.setAttribute('data-local', scopeState.local ? '1' : '0');
    selectorRoot.setAttribute('data-state', scopeState.state ? '1' : '0');
    selectorRoot.setAttribute('data-federal', scopeState.federal ? '1' : '0');
    scopeButtons.forEach((btn) => {
      const scope = btn.getAttribute('data-scope');
      if (!scope) return;
      const active = !!scopeState[scope];
      btn.setAttribute('aria-pressed', active ? 'true' : 'false');
      btn.classList.toggle('is-active', active);
    });
  }

  function applyScopeVisibility() {
    document.querySelectorAll('[data-scope-card]').forEach((card) => {
      const scope = card.getAttribute('data-scope-card');
      if (!scope) return;
      const active = !!scopeState[scope];
      if (active) {
        card.removeAttribute('hidden');
        card.setAttribute('aria-hidden', 'false');
      } else {
        card.setAttribute('hidden', '');
        card.setAttribute('aria-hidden', 'true');
      }
    });
  }

  function broadcastScope(origin = 'inputs') {
    window.dispatchEvent(
      new CustomEvent('t1:scope-changed', {
        detail: { ...scopeState, __origin: origin },
      }),
    );
  }

  function handleFederalTransition(prev, next) {
    if (prev === next) return;
    if (!next) {
      lastFederalPreference = state.includeFederal;
      if (state.includeFederal) {
        state.includeFederal = false;
        toggleControllers.get('fed')?.activate('0', false);
        if ($('fed')) $('fed').value = '0';
      }
    } else {
      state.includeFederal = lastFederalPreference;
      toggleControllers.get('fed')?.activate(state.includeFederal ? '1' : '0', false);
      if ($('fed')) $('fed').value = state.includeFederal ? '1' : '0';
    }
  }

  function setScope(scope, value, opts = {}) {
    if (!(scope in scopeState)) return;
    if (scopeState[scope] === value) return;
    const prevFederal = scopeState.federal;
    scopeState[scope] = value;
    updateSelectorChips();
    applyScopeVisibility();
    state.scopes = { ...scopeState };
    handleFederalTransition(prevFederal, scopeState.federal);
    if (scope === 'local' && controller && typeof controller.setLocalScope === 'function') {
      controllerLocalScope = controller.setLocalScope(
        { enabled: value },
        { emit: false, schedule: false, origin: 'inputs-scope' },
      );
      if (value && controllerLocalScope?.countyFips) {
        syncGeoSelectionFromLocal(
          controllerLocalScope.countyFips,
          controllerLocalScope.stateFips || shareModel.state.fips,
          'inputs-scope',
        );
      }
      if (!value) {
        syncGeoSelectionFromLocal(null, null, 'inputs-scope');
      }
    }
    if (opts.broadcast !== false) broadcastScope('inputs');
    if (opts.emit !== false) emit();
  }

  function updateLocalAvailability() {
    if (!localButton) return;
    localButton.removeAttribute('disabled');
    localButton.removeAttribute('aria-disabled');
  }

  if (scopeButtons.length) {
    scopeButtons.forEach((btn) => {
      const scope = btn.getAttribute('data-scope');
      if (!scope) return;
      btn.addEventListener('click', () => {
        if (btn.hasAttribute('disabled')) return;
        const next = !scopeState[scope];
        if (scope === 'local') userInteractedLocal = true;
        setScope(scope, next);
      });
    });

    const chipsContainer = selectorRoot?.querySelector('.scope-selector__chips');
    if (chipsContainer) {
      chipsContainer.addEventListener('keydown', (event) => {
        const key = event.key;
        if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(key)) return;
        event.preventDefault();
        const buttons = Array.from(chipsContainer.querySelectorAll('button[data-scope]'));
        if (!buttons.length) return;
        const focusedIndex = buttons.findIndex((btn) => btn === document.activeElement);
        const activeIndex = focusedIndex >= 0 ? focusedIndex : buttons.findIndex((btn) => btn.classList.contains('is-active'));
        let nextIndex = activeIndex >= 0 ? activeIndex : 0;
        if (key === 'ArrowLeft') nextIndex = (nextIndex - 1 + buttons.length) % buttons.length;
        if (key === 'ArrowRight') nextIndex = (nextIndex + 1) % buttons.length;
        if (key === 'Home') nextIndex = 0;
        if (key === 'End') nextIndex = buttons.length - 1;
        const nextBtn = buttons[nextIndex];
        if (nextBtn) nextBtn.focus();
      });
    }
  }

  updateSelectorChips();
  applyScopeVisibility();
  state.scopes = { ...scopeState };
  updateLocalAvailability();
  broadcastScope('inputs');

  window.addEventListener('t1:scope-changed', (event) => {
    const detail = event.detail || {};
    if (detail.__origin === 'inputs') return;
    const prevFederal = scopeState.federal;
    let changed = false;
    ['local', 'state', 'federal'].forEach((scope) => {
      if (typeof detail[scope] === 'boolean' && scopeState[scope] !== detail[scope]) {
        scopeState[scope] = detail[scope];
        changed = true;
      }
    });
    if (!changed) return;
    updateSelectorChips();
    applyScopeVisibility();
    state.scopes = { ...scopeState };
    handleFederalTransition(prevFederal, scopeState.federal);
    updateLocalAvailability();
    emit();
  });

  window.addEventListener('t1:local-scope', (event) => {
    const detail = event.detail || {};
    if (detail) {
      controllerLocalScope = {
        ...(controllerLocalScope || {}),
        ...detail,
        stateFips: detail.stateFips !== undefined
          ? normalizeStateFipsValue(detail.stateFips)
          : controllerLocalScope?.stateFips || null,
        countyFips: detail.countyFips !== undefined
          ? normalizeCountyFipsValue(detail.countyFips)
          : controllerLocalScope?.countyFips || null,
      };
    }
    if (!shareModel.local) shareModel.local = { zip: null, countyFips: null, toggles: 0 };
    if (detail.zip !== undefined) shareModel.local.zip = detail.zip;
    if (detail.countyFips !== undefined) shareModel.local.countyFips = detail.countyFips;
    if (typeof detail.toggles === 'number') shareModel.local.toggles = detail.toggles;
  });

  window.addEventListener('t1:state', (event) => {
    const detail = event.detail || {};
    let code = null;
    if (detail && detail.geoSelection && detail.geoSelection.stateFips) {
      const dig = String(detail.geoSelection.stateFips).slice(0, 2).padStart(2, '0');
      code = FIPS_TO_CODE[dig] || null;
      state.locality.stateFips = detail.geoSelection.stateFips;
    } else if (detail && detail.code) {
      code = String(detail.code).toUpperCase();
      if (CODE_TO_FIPS[code]) state.locality.stateFips = CODE_TO_FIPS[code];
    } else if (detail && detail.fips) {
      const dig = String(detail.fips).padStart(2, '0').slice(0, 2);
      code = FIPS_TO_CODE[dig] || null;
      state.locality.stateFips = dig;
    }
    const prevHasState = hasState;
    hasState = !!code;
    updateLocalAvailability();
    if (hasState && !prevHasState && !scopeState.local && !userInteractedLocal) {
      setScope('local', true);
    }
    if (!hasState) {
      userInteractedLocal = false;
    }
  });

  requestAnimationFrame(() => {
    incEl?.dispatchEvent(new Event('input', { bubbles: false }));
    hvEl?.dispatchEvent(new Event('input', { bubbles: false }));
    ltcgEl?.dispatchEvent(new Event('input', { bubbles: false }));
  });

  (function formatOnLoad() {
    const fields = [incEl, hvEl, miEl, mpgEl, ltcgEl];
    for (const el of fields) {
      if (!el) continue;
      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';
    }
  })();
  emit();

  window.addEventListener('t1:locality-changed', (event) => {
    const detail = event.detail || {};
    const normalizedCounty = normalizeCountyFipsValue(detail.fipsCounty || detail.countyFips || detail.fips || null);
    const stateFipsForCounty = resolveLocalStateFips(detail);
    state.locality = {
      zip: detail.zip,
      city: detail.city,
      countyName: detail.countyName,
      fipsCounty: normalizedCounty,
      state: detail.state || null,
      stateFips: stateFipsForCounty,
      source: detail.source || null
    };
    emit();
    if (controller && typeof controller.setLocalScope === 'function') {
      controllerLocalScope = controller.setLocalScope(
        {
          zip: detail.zip ?? null,
          city: detail.city ?? null,
          countyFips: normalizedCounty,
          stateFips: stateFipsForCounty,
        },
        { schedule: false, origin: detail.source || 'inputs-locality' },
      );
    }
    syncGeoSelectionFromLocal(
      normalizedCounty,
      stateFipsForCounty,
      detail.source || 'inputs-locality',
    );
  });

  document.addEventListener('input', (ev) => {
    const el = ev.target;
    if (!(el && el.id && (el.id === 'inc' || el.id === 'hv' || el.id === 'ltcg'))) return;
    const start = el.selectionStart;
    const before = el.value.slice(0, start);
    const offsetDigits = (before.match(/[0-9]/g) || []).length;
    const raw = parseNum(el.value);
    el.value = raw ? fmtNum(raw) : '';
    let seen = 0;
    let pos = 0;
    while (pos < el.value.length && seen < offsetDigits) {
      if (/[0-9]/.test(el.value[pos])) seen++;
      pos++;
    }
    try { el.setSelectionRange(pos, pos); } catch {}
  }, true);
})();
</script>




