---
import ScopeSelector from './ScopeSelector.astro';
import LocalityPicker from './LocalityPicker.astro';
import InputsLocal from './InputsLocal.astro';
import InputsState from './InputsState.astro';
import InputsFederal from './InputsFederal.astro';
---

<form class="inputs-panel stack" aria-label="Tax inputs">
  <ScopeSelector />
  <section class="scope-card scope-card--local" data-scope-card="local" hidden aria-hidden="true">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--local">Local</span>
        <h3 class="scope-card__heading">Local taxes</h3>
      </div>
      <p class="scope-card__desc">City, county, and district add-ons.</p>
    </header>
    <LocalityPicker />
    <InputsLocal />
  </section>

  <section class="scope-card scope-card--state" data-scope-card="state" aria-hidden="false">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--state">State</span>
        <h3 class="scope-card__heading">State taxes</h3>
      </div>
      <p class="scope-card__desc">Income, property, sales, motor fuel, and excise.</p>
    </header>
    <InputsState />
  </section>

  <section class="scope-card scope-card--federal" data-scope-card="federal" aria-hidden="false">
    <header class="scope-card__header">
      <div>
        <span class="scope-card__badge scope-card__badge--federal">Federal</span>
        <h3 class="scope-card__heading">Federal taxes</h3>
      </div>
      <p class="scope-card__desc">Income, payroll, and capital gains layers.</p>
    </header>
    <InputsFederal />
  </section>
</form>

<script type="module">
/* Inputs client: live format, instant emit, toggle groups + scopes */
(function () {
  const $ = (id) => document.getElementById(id);

  const scopeState = { local: false, state: true, federal: true };
  let lastFederalPreference = true;

  function currentURL() { try { return new URL(window.location.href); } catch { return null; } }
  function readInputsFromURL(u) {
    const gp = (k) => u.searchParams.get(k);
    const pnum = (v) => Number(String(v || '').replace(/[^0-9.-]/g, '')) || 0;
    return {
      filingStatus: gp('fs') || 'single',
      income: gp('inc') ? pnum(gp('inc')) : 60000,
      homeowner: (gp('ho') ?? '1') === '1',
      homeValue: gp('hv') ? pnum(gp('hv')) : 300000,
      miles: gp('mi') ? +gp('mi') : 12000,
      mpg: gp('mpg') ? +gp('mpg') : 28,
      spendingShare: gp('ss') ? +gp('ss') : 0.6,
      taxableShare: gp('ts') ? +gp('ts') : 0.55,
      cigPacksPerWeek: gp('cig') ? +gp('cig') : 0,
      alcoholUnitsPerWeek: gp('alc') ? +gp('alc') : 0,
      includeFederal: (gp('fed') ?? '1') === '1',
      ltcg: gp('ltcg') ? pnum(gp('ltcg')) : 0,
    };
  }
  function writeInputsToURL(u, i) {
    const sp = u.searchParams;
    const set = (k, v) => { if (v == null || v === '' || v === 0) sp.delete(k); else sp.set(k, String(v)); };
    set('fs', i.filingStatus);
    set('inc', i.income | 0);
    set('ho', i.homeowner ? '1' : '0');
    set('hv', i.homeValue | 0);
    set('mi', i.miles);
    set('mpg', i.mpg);
    set('ss', i.spendingShare);
    set('ts', i.taxableShare);
    set('cig', i.cigPacksPerWeek || null);
    set('alc', i.alcoholUnitsPerWeek || null);
    set('fed', i.includeFederal ? '1' : '0');
    set('ltcg', i.ltcg || null);
    return u;
  }

  function parseNum(v) {
    if (v == null) return 0;
    return Number(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  const nf = new Intl.NumberFormat('en-US');
  function fmtNum(n) { return nf.format(n | 0); }

  function attachLiveFormatter(inputEl) {
    if (!inputEl) return;
    const handler = (e) => {
      const el = e.target;
      const start = el.selectionStart;
      const before = el.value.slice(0, start);
      const offsetDigits = (before.match(/[0-9]/g) || []).length;

      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';

      let seen = 0;
      let pos = 0;
      while (pos < el.value.length && seen < offsetDigits) {
        if (/[0-9]/.test(el.value[pos])) seen++;
        pos++;
      }
      try { el.setSelectionRange(pos, pos); } catch {}
    };
    inputEl.addEventListener('input', handler);
    inputEl.addEventListener('keyup', handler);
    inputEl.addEventListener('change', handler);

    let running = false;
    const tick = () => {
      if (!running) return;
      const el = inputEl;
      const raw = parseNum(el.value);
      const formatted = raw ? fmtNum(raw) : '';
      if (el.value !== formatted) {
        const start = el.selectionStart;
        const before = el.value.slice(0, start);
        const offsetDigits = (before.match(/[0-9]/g) || []).length;
        el.value = formatted;
        let seen = 0;
        let pos = 0;
        while (pos < el.value.length && seen < offsetDigits) {
          if (/[0-9]/.test(el.value[pos])) seen++;
          pos++;
        }
        try { el.setSelectionRange(pos, pos); } catch {}
      }
      requestAnimationFrame(tick);
    };
    inputEl.addEventListener('focus', () => { if (!running) { running = true; requestAnimationFrame(tick); } });
    inputEl.addEventListener('blur', () => { running = false; });
  }

  const init = (() => {
    const u = currentURL();
    const defaults = {
      filingStatus: 'single',
      income: 60000,
      homeowner: true,
      homeValue: 300000,
      miles: 12000,
      mpg: 28,
      spendingShare: 0.6,
      taxableShare: 0.55,
      cigPacksPerWeek: 0,
      alcoholUnitsPerWeek: 0,
      includeFederal: true,
      ltcg: 0,
    };
    if (!u) return defaults;
    try {
      const parsed = readInputsFromURL(u);
      return { ...defaults, ...parsed };
    } catch {
      return defaults;
    }
  })();

  if ($('fs')) $('fs').value = init.filingStatus;
  if ($('inc')) $('inc').value = fmtNum(init.income);
  if ($('ho')) $('ho').value = init.homeowner ? '1' : '0';
  if ($('hv')) $('hv').value = fmtNum(init.homeValue);
  if ($('mi')) $('mi').value = String(init.miles);
  if ($('mpg')) $('mpg').value = String(init.mpg);
  if ($('ss')) $('ss').value = String(init.spendingShare);
  if ($('ts')) $('ts').value = String(init.taxableShare);
  if ($('cig')) $('cig').value = String(init.cigPacksPerWeek);
  if ($('alc')) $('alc').value = String(init.alcoholUnitsPerWeek);
  if ($('fed')) $('fed').value = init.includeFederal ? '1' : '0';
  if ($('ltcg')) $('ltcg').value = fmtNum(init.ltcg);

  const ssBadge = document.getElementById('ssb');
  if (ssBadge) ssBadge.textContent = Math.round(init.spendingShare * 100) + '%';
  const tsBadge = document.getElementById('tsb');
  if (tsBadge) tsBadge.textContent = Math.round(init.taxableShare * 100) + '%';

  const state = { ...init };
  lastFederalPreference = state.includeFederal;

  const toggleControllers = new Map();

  function emit() {
    const cu = currentURL();
    if (!cu) return;
    const u = writeInputsToURL(cu, state);
    history.replaceState({}, '', u);
    queueMicrotask(() => {
      window.dispatchEvent(new CustomEvent('t1:inputs', { detail: { ...state } }));
    });
  }

  function initToggleGroup(targetId, updater) {
    const hidden = $(targetId);
    const container = document.querySelector(`.toggle-group[data-target="${targetId}"]`);
    if (!hidden || !container) return;
    const buttons = Array.from(container.querySelectorAll('button[data-value]'));
    if (!buttons.length) return;

    const activate = (value, shouldEmit = true) => {
      hidden.value = value;
      buttons.forEach((btn) => {
        const isActive = btn.getAttribute('data-value') === value;
        btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
        btn.tabIndex = isActive ? 0 : -1;
        btn.classList.toggle('is-active', isActive);
      });
      if (typeof updater === 'function') updater(value);
      if (shouldEmit) emit();
    };

    container.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-value]');
      if (!btn) return;
      const value = btn.getAttribute('data-value');
      if (!value) return;
      activate(value);
      btn.focus();
    });

    container.addEventListener('keydown', (ev) => {
      const key = ev.key;
      if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(key)) return;
      ev.preventDefault();
      const currentIndex = buttons.findIndex((btn) => btn.getAttribute('aria-checked') === 'true');
      let nextIndex = currentIndex >= 0 ? currentIndex : 0;
      if (key === 'ArrowLeft') nextIndex = (nextIndex - 1 + buttons.length) % buttons.length;
      if (key === 'ArrowRight') nextIndex = (nextIndex + 1) % buttons.length;
      if (key === 'Home') nextIndex = 0;
      if (key === 'End') nextIndex = buttons.length - 1;
      const next = buttons[nextIndex];
      if (!next) return;
      activate(next.getAttribute('data-value'));
      next.focus();
    });

    activate(hidden.value || buttons[0].getAttribute('data-value'), false);
    toggleControllers.set(targetId, { activate });
  }

  document.getElementById('fs')?.addEventListener('change', (e) => {
    state.filingStatus = e.target.value;
    emit();
  });

  const incEl = $('inc'); attachLiveFormatter(incEl);
  incEl?.addEventListener('input', (e) => { state.income = parseNum(e.target.value); emit(); });

  const hvEl = $('hv'); attachLiveFormatter(hvEl);
  hvEl?.addEventListener('input', (e) => { state.homeValue = parseNum(e.target.value); emit(); });

  const miEl = $('mi'); attachLiveFormatter(miEl);
  miEl?.addEventListener('input', (e) => { state.miles = +parseNum(e.target.value) || 0; emit(); });

  const mpgEl = $('mpg'); attachLiveFormatter(mpgEl);
  mpgEl?.addEventListener('input', (e) => { state.mpg = +parseNum(e.target.value) || 1; emit(); });

  $('ss')?.addEventListener('input', (e) => {
    state.spendingShare = +e.target.value;
    if (ssBadge) ssBadge.textContent = Math.round(state.spendingShare * 100) + '%';
    emit();
  });

  $('ts')?.addEventListener('input', (e) => {
    state.taxableShare = +e.target.value;
    if (tsBadge) tsBadge.textContent = Math.round(state.taxableShare * 100) + '%';
    emit();
  });

  $('cig')?.addEventListener('input', (e) => { state.cigPacksPerWeek = +e.target.value || 0; emit(); });
  $('alc')?.addEventListener('input', (e) => { state.alcoholUnitsPerWeek = +e.target.value || 0; emit(); });

  const ltcgEl = $('ltcg'); attachLiveFormatter(ltcgEl);
  ltcgEl?.addEventListener('input', (e) => { state.ltcg = parseNum(e.target.value); emit(); });

  initToggleGroup('ho', (value) => { state.homeowner = (value === '1'); });
  initToggleGroup('fed', (value) => {
    const active = value === '1';
    state.includeFederal = active;
    lastFederalPreference = active;
    if ($('fed')) $('fed').value = active ? '1' : '0';
  });

  function applyScopeVisibility() {
    document.querySelectorAll('[data-scope-card]').forEach((card) => {
      const scope = card.getAttribute('data-scope-card');
      if (!scope) return;
      const active = !!scopeState[scope];
      if (active) {
        card.removeAttribute('hidden');
        card.setAttribute('aria-hidden', 'false');
      } else {
        card.setAttribute('hidden', '');
        card.setAttribute('aria-hidden', 'true');
      }
    });
  }

  window.addEventListener('t1:scope-changed', (event) => {
    const detail = event.detail || {};
    const prevFederal = scopeState.federal;
    ['local', 'state', 'federal'].forEach((scope) => {
      if (typeof detail[scope] === 'boolean') {
        scopeState[scope] = detail[scope];
      }
    });
    applyScopeVisibility();

    if (prevFederal !== scopeState.federal) {
      if (!scopeState.federal) {
        lastFederalPreference = state.includeFederal;
        if (state.includeFederal) {
          state.includeFederal = false;
          toggleControllers.get('fed')?.activate('0', false);
          if ($('fed')) $('fed').value = '0';
          emit();
        }
      } else {
        state.includeFederal = lastFederalPreference;
        toggleControllers.get('fed')?.activate(state.includeFederal ? '1' : '0', false);
        if ($('fed')) $('fed').value = state.includeFederal ? '1' : '0';
        emit();
      }
    }
  });

  applyScopeVisibility();

  requestAnimationFrame(() => {
    incEl?.dispatchEvent(new Event('input', { bubbles: false }));
    hvEl?.dispatchEvent(new Event('input', { bubbles: false }));
    ltcgEl?.dispatchEvent(new Event('input', { bubbles: false }));
  });

  (function formatOnLoad() {
    const fields = [incEl, hvEl, miEl, mpgEl, ltcgEl];
    for (const el of fields) {
      if (!el) continue;
      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';
    }
  })();
  emit();

  document.addEventListener('input', (ev) => {
    const el = ev.target;
    if (!(el && el.id && (el.id === 'inc' || el.id === 'hv' || el.id === 'ltcg'))) return;
    const start = el.selectionStart;
    const before = el.value.slice(0, start);
    const offsetDigits = (before.match(/[0-9]/g) || []).length;
    const raw = parseNum(el.value);
    el.value = raw ? fmtNum(raw) : '';
    let seen = 0;
    let pos = 0;
    while (pos < el.value.length && seen < offsetDigits) {
      if (/[0-9]/.test(el.value[pos])) seen++;
      pos++;
    }
    try { el.setSelectionRange(pos, pos); } catch {}
  }, true);
})();
</script>
