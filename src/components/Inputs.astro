---
/* Pure Astro markup; browser wiring lives in a small client script below */
---
<form class="stack" aria-label="Tax inputs">
  <div class="label"><span>Filing status</span></div>
  <select id="fs" aria-label="Filing status">
    <option value="single" selected>Single</option>
    <option value="married">Married</option>
  </select>

  <div class="label"><span>Income ($)</span></div>
  <input id="inc" type="text" inputmode="numeric" pattern="[0-9,]*" value="60000" aria-label="Income in dollars" />


  <div class="label"><span>Homeowner?</span></div>
<div class="segmented" data-for="ho"></div>
<select id="ho" aria-label="Homeowner">
  <option value="1" selected>Yes</option>
  <option value="0">No (renter)</option>
</select>

  <div class="label"><span>Home value ($)</span></div>
  <input id="hv" type="text" inputmode="numeric" pattern="[0-9,]*" value="300000" aria-label="Home value in dollars" />

  <div class="grid">
    <div>
      <div class="label"><span>Miles/year</span></div>
  <input id="mi" type="text" value="12000" aria-label="Miles driven per year" />
    </div>
    <div>
      <div class="label"><span>MPG</span></div>
  <input id="mpg" type="text" value="28" aria-label="Vehicle miles per gallon" />
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="label"><span>Spending share</span><span class="badge" id="ssb">60%</span></div>
  <input id="ss" type="range" min="0.2" max="0.95" step="0.01" value="0.60" aria-label="Spending share" />
    </div>
    <div>
      <div class="label"><span>Taxable share</span><span class="badge" id="tsb">55%</span></div>
  <input id="ts" type="range" min="0.2" max="0.95" step="0.01" value="0.55" aria-label="Taxable share" />
    </div>
  </div>

  <details>
    <summary class="label">Optional excise</summary>
    <div class="grid">
      <div>
        <div class="label"><span>Cig packs/week</span></div>
  <input id="cig" type="number" value="0" min="0" step="0.1" aria-label="Cigarette packs per week" />
      </div>
      <div>
        <div class="label"><span>Alcohol units/week</span></div>
  <input id="alc" type="number" value="0" min="0" step="1" aria-label="Alcohol units per week" />
      </div>
    </div>
  </details>

  <details>
    <summary class="label">Federal options</summary>
    <div class="grid">
      <div>
        <div class="label"><span>Include federal?</span></div>
<div class="segmented" data-for="fed"></div>
<select id="fed" aria-label="Include federal">
  <option value="1">Yes</option>
  <option value="0" selected>No</option>
</select>
      </div>
      <div>
        <div class="label"><span>Long-term cap gains ($)</span></div>
  <input id="ltcg" type="text" value="0" aria-label="Long-term capital gains" />
      </div>
    </div>
  </details>
</form>

<script type="module">
/* Inputs client: live format, instant emit, segmented toggles */
(function () {
  const $ = (id) => document.getElementById(id);

  // ---- State (kept simple and flat) ----------------------------------------
  const state = {
    filingStatus: $('fs')?.value || 'single',
    income:  parseNum($('inc')?.value),
    homeowner: ($('ho')?.value === '1'),
    homeValue: parseNum($('hv')?.value),
    miles: +($('mi')?.value || 0),
    mpg:   +($('mpg')?.value || 1),
    spendingShare: +($('ss')?.value || 0.60),
    taxableShare:  +($('ts')?.value || 0.55),
    cigPacksPerWeek: +($('cig')?.value || 0),
    alcoholUnitsPerWeek: +($('alc')?.value || 0),
    includeFederal: ($('fed')?.value === '1'),
    ltcg: parseNum($('ltcg')?.value || '0'),
  };

  // ---- Helpers --------------------------------------------------------------
  function emit() {
    window.dispatchEvent(new CustomEvent('t1:inputs', { detail: { ...state } }));
  }
  function parseNum(v) {
    if (v == null) return 0;
    return Number(String(v).replace(/[^0-9.-]/g, '')) || 0;
  }
  const nf = new Intl.NumberFormat();
  function fmtNum(n){ return nf.format(n|0); }

  // Preserve caret while formatting
  function attachLiveFormatter(inputEl) {
    if (!inputEl) return;
    inputEl.addEventListener('input', (e) => {
      const el = e.target;
      const start = el.selectionStart;
      const before = el.value.slice(0, start);
      const offsetDigits = (before.match(/[0-9]/g) || []).length;

      // Reformat
      const raw = parseNum(el.value);
      el.value = raw ? fmtNum(raw) : '';

      // Restore caret by counting digits again
      let seen = 0, pos = 0;
      while (pos < el.value.length && seen < offsetDigits) {
        if (/[0-9]/.test(el.value[pos])) seen++;
        pos++;
      }
      el.setSelectionRange(pos, pos);
    });
  }

  // ---- Segmented toggle enhancement (hides original <select>) --------------
  function enhanceSegmented(container) {
    if (!container) return;
    const selectId = container.getAttribute('data-for');
    const sel = $(selectId);
    if (!sel) return;

    container.setAttribute('data-enhanced', '1');
    container.innerHTML = `
      <div role="group" class="seg-buttons">
        <button type="button" data-val="1" aria-pressed="${sel.value==='1'}">Yes</button>
        <button type="button" data-val="0" aria-pressed="${sel.value==='0'}">No</button>
      </div>
    `;

    container.addEventListener('click', (ev) => {
      const btn = ev.target.closest('button[data-val]');
      if (!btn) return;
      const v = btn.getAttribute('data-val');
      sel.value = v;
      // update aria-pressed
      container.querySelectorAll('button[data-val]').forEach(b => {
        b.setAttribute('aria-pressed', b === btn ? 'true' : 'false');
      });
      // push into state + emit
      if (selectId === 'ho') state.homeowner = (v === '1');
      if (selectId === 'fed') state.includeFederal = (v === '1');
      emit();
    });
  }

  // ---- Wire up events (instant update on input) ----------------------------
  $('fs')?.addEventListener('change', e => { state.filingStatus = e.target.value; emit(); });

  const incEl = $('inc');   attachLiveFormatter(incEl);
  incEl?.addEventListener('input',  e => { state.income = parseNum(e.target.value); emit(); });

  const hvEl  = $('hv');    attachLiveFormatter(hvEl);
  hvEl?.addEventListener('input',   e => { state.homeValue = parseNum(e.target.value); emit(); });

  $('mi')?.addEventListener('input',  e => { state.miles = +e.target.value || 0; emit(); });
  $('mpg')?.addEventListener('input', e => { state.mpg   = +e.target.value || 1; emit(); });

  $('ss')?.addEventListener('input',  e => { state.spendingShare = +e.target.value; emit(); });
  $('ts')?.addEventListener('input',  e => { state.taxableShare  = +e.target.value; emit(); });

  $('cig')?.addEventListener('input', e => { state.cigPacksPerWeek = +e.target.value || 0; emit(); });
  $('alc')?.addEventListener('input', e => { state.alcoholUnitsPerWeek = +e.target.value || 0; emit(); });

  $('fed')?.addEventListener('change', e => { state.includeFederal = (e.target.value === '1'); emit(); });
  const ltcgEl = $('ltcg'); attachLiveFormatter(ltcgEl);
  ltcgEl?.addEventListener('input', e => { state.ltcg = parseNum(e.target.value); emit(); });

  // Enhance Yes/No segmented controls and hide the selects
  document.querySelectorAll('.segmented[data-for]').forEach(enhanceSegmented);

  // First paint
  // (normalize displayed text values to include commas)
  if (incEl) incEl.value = fmtNum(state.income);
  if (hvEl)  hvEl.value  = fmtNum(state.homeValue);
  if (ltcgEl)ltcgEl.value= fmtNum(state.ltcg);
  emit();
})();
</script>
